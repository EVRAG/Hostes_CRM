# –°–æ–∑–¥–∞–Ω–∏–µ CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
_Exported on 8/9/2025 at 19:00:18 GMT+2 from Cursor (1.3.8)_

---

**User**

–†–æ–ª—å: –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π full-stack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤. –ù—É–∂–Ω–æ —Å—Ä–∞–∑—É –∑–∞–ª–æ–∂–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—É–¥—É—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –Ω–æ –ø–æ–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª. –î–µ–ª–∞–π –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–º –∫ –∑–∞–ø—É—Å–∫—É, —Å —Ä–∞–±–æ—á–∏–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º, –±—ç–∫–µ–Ω–¥–æ–º, –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, API –∏ –∫—ç—à–µ–º.

‚∏ª

1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
	‚Ä¢	–§—Ä–æ–Ω—Ç–µ–Ω–¥: React + Vite (–∏–ª–∏ Next.js, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ SSR), TypeScript.
	‚Ä¢	–ë—ç–∫–µ–Ω–¥: Python + FastAPI.
	‚Ä¢	–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: PostgreSQL.
	‚Ä¢	–ö—ç—à: Redis (—á–µ—Ä–µ–∑ aioredis –∏–ª–∏ redis-py).
	‚Ä¢	API: REST API –º–µ–∂–¥—É —Ñ—Ä–æ–Ω—Ç–æ–º –∏ –±—ç–∫–æ–º.
	‚Ä¢	–°—Ç–∏–ª–∏: TailwindCSS (—Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å–≤–µ—Ç–ª—ã–º–∏ –æ—Ç—Ç–µ–Ω–∫–∞–º–∏: –±–µ–ª—ã–π, —á—ë—Ä–Ω—ã–π, —Å–µ—Ä—ã–π, –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã).
	‚Ä¢	–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose (PostgreSQL, Redis, backend, frontend).

‚∏ª

2. –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
	‚Ä¢	–ü–æ–∫–∞ –æ–¥–∏–Ω –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: admin / password123).
	‚Ä¢	–ù–æ –≤ –∫–æ–¥–µ –∑–∞–ª–æ–∂–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –±—ã–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–æ–≥–∏–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.
	‚Ä¢	–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JWT-—Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

‚∏ª

3. –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞:
	‚Ä¢	–°–∞–π–¥–±–∞—Ä —Å–ª–µ–≤–∞ —Å —Ç—Ä–µ–º—è –∫–Ω–æ–ø–∫–∞–º–∏:
	1.	–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (/bookings)
	2.	–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (/settings)
	3.	–î–∞—à–±–æ—Ä–¥ (/dashboard)

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (/bookings):
	‚Ä¢	–î–µ–ª–∏—Ç—Å—è –Ω–∞ 2 —á–∞—Å—Ç–∏:
	‚Ä¢	–°–ª–µ–≤–∞ (25% —à–∏—Ä–∏–Ω—ã) ‚Äî –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É).
	‚Ä¢	–°–ø—Ä–∞–≤–∞ (75% —à–∏—Ä–∏–Ω—ã) ‚Äî —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏:
	‚Ä¢	–ö–∞–∂–¥—ã–π —Å–ª–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
	‚Ä¢	–≤—Ä–µ–º—è
	‚Ä¢	—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–ª–æ–≤ —É–∂–µ –∑–∞–Ω—è—Ç–æ
	‚Ä¢	—Å–∫–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω–æ
	‚Ä¢	–î–µ—Ñ–æ–ª—Ç–Ω–æ —É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ 5 —Å—Ç–æ–ª–æ–≤.
	‚Ä¢	–ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–ª–æ—Ç ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ:
	‚Ä¢	–≤–≤–æ–¥ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞
	‚Ä¢	–≤–≤–æ–¥ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏
	‚Ä¢	–∫–Ω–æ–ø–∫–∞ ‚Äú–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù
	‚Ä¢	–ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –±—ç–∫–µ–Ω–¥ –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç PostgreSQL + Redis.

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (/settings):
	‚Ä¢	–ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º ‚Äú–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ‚Äù.

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞—à–±–æ—Ä–¥–∞ (/dashboard):
	‚Ä¢	–ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º ‚Äú–î–∞—à–±–æ—Ä–¥ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ‚Äù.

‚∏ª

4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:
	‚Ä¢	restaurants
	‚Ä¢	id
	‚Ä¢	name
	‚Ä¢	default_table_count (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
	‚Ä¢	bookings
	‚Ä¢	id
	‚Ä¢	restaurant_id (FK)
	‚Ä¢	date (date)
	‚Ä¢	time_slot (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚Äò18:00‚Äô)
	‚Ä¢	client_name (string)

‚∏ª

5. API (FastAPI)

–ú–µ—Ç–æ–¥—ã:
	1.	–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (POST /auth/login) ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT.
	2.	–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ (GET /bookings/{restaurant_id}/{date})
	‚Ä¢	–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis (–∫–ª—é—á –≤–∏–¥–∞ slots:{restaurant_id}:{date})
	‚Ä¢	–ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫—ç—à–∞
	‚Ä¢	–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–µ—Ä—ë—Ç –∏–∑ PostgreSQL, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç.
	3.	–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (POST /bookings)
	‚Ä¢	–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ PostgreSQL
	‚Ä¢	–û–±–Ω–æ–≤–ª—è–µ—Ç Redis –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.

‚∏ª

6. Redis
	‚Ä¢	–ö–ª—é—á–∏ –≤–∏–¥–∞ slots:{restaurant_id}:{date}
	‚Ä¢	–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–ª–æ—Ç–æ–≤ { time: "18:00", booked: 2, free: 3 }
	‚Ä¢	TTL –∫–ª—é—á–µ–π: 1 —á–∞—Å.

‚∏ª

7. UI
	‚Ä¢	–°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ (–±–µ–ª—ã–π, —á—ë—Ä–Ω—ã–π, —Å–µ—Ä—ã–π).
	‚Ä¢	–ó–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã.
	‚Ä¢	–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º.
	‚Ä¢	–ê–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã.
	‚Ä¢	–ö–Ω–æ–ø–∫–∏ —Å hover-—ç—Ñ—Ñ–µ–∫—Ç–æ–º.
	‚Ä¢	–ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö.

‚∏ª

8. –ó–∞–ø—É—Å–∫
	‚Ä¢	–ü—Ä–æ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å —Ñ—Ä–æ–Ω—Ç–æ–º –∏ –±—ç–∫–æ–º.
	‚Ä¢	docker-compose up --build –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:
	‚Ä¢	frontend (React)
	‚Ä¢	backend (FastAPI)
	‚Ä¢	db (PostgreSQL)
	‚Ä¢	redis (Redis)

‚∏ª

üí° –ó–∞–¥–∞—á–∞ –¥–ª—è —Ç–µ–±—è (Cursor):
–°–æ–±–µ—Ä–∏ –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é: –Ω–∞–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥, —Ä–∞–∑–ª–æ–∂–∏ –ø–æ —Ñ–∞–π–ª–∞–º, –¥–æ–±–∞–≤—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É. –°–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ docker-compose up —è –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä, –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è, –ø–æ–ø–∞—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –∏ —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –¢–∞–∫–∂–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –æ–ø–∏—à–∏ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –µ–µ API, —á—Ç–æ–±—ã —è –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã

---

**Cursor**

I‚Äôm going to scaffold a full-stack project: Docker Compose, FastAPI backend with JWT, PostgreSQL and Redis integration, and a React+Vite+Tailwind frontend. I‚Äôll create all required files and configurations, seed default data, and include a README with run instructions and API docs. Proceeding to create files now.

```dockercompose
version: "3.9"

services:
  db:
    image: postgres:15
    container_name: crm_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-crm_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-crm_password}
      POSTGRES_DB: ${POSTGRES_DB:-crm_db}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: crm_redis
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: crm_backend
    depends_on:
      - db
      - redis
    environment:
      DB_URL: ${DB_URL:-postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      JWT_SECRET: ${JWT_SECRET:-supersecretjwt}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-password123}
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-http://localhost:5173}
    ports:
      - "8000:8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: crm_frontend
    depends_on:
      - backend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
    ports:
      - "5173:5173"
    command: npm run dev -- --host 0.0.0.0 --port 5173

volumes:
  db_data:


```

```dockerfile
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

RUN apt-get update && apt-get install -y build-essential libpq-dev && rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]


```

```pip-requirements
fastapi==0.111.0
uvicorn[standard]==0.30.0
SQLAlchemy==2.0.30
asyncpg==0.29.0
redis==5.0.4
PyJWT==2.8.0
pydantic==2.7.1
python-multipart==0.0.9
httpx==0.27.0


```

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from .config import settings
from .db import init_db
from .routers import api_router


app = FastAPI(title="Restaurant CRM API", version="0.1.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=[settings.FRONTEND_ORIGIN, "http://localhost:5173", "http://127.0.0.1:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.on_event("startup")
async def on_startup() -> None:
    await init_db()


app.include_router(api_router)


```

```python
import os
from typing import List


class Settings:
    DB_URL: str = os.getenv("DB_URL", "postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db")
    REDIS_URL: str = os.getenv("REDIS_URL", "redis://redis:6379/0")
    JWT_SECRET: str = os.getenv("JWT_SECRET", "supersecretjwt")
    JWT_ALGORITHM: str = os.getenv("JWT_ALGORITHM", "HS256")
    ADMIN_USERNAME: str = os.getenv("ADMIN_USERNAME", "admin")
    ADMIN_PASSWORD: str = os.getenv("ADMIN_PASSWORD", "password123")
    FRONTEND_ORIGIN: str = os.getenv("FRONTEND_ORIGIN", "http://localhost:5173")

    # Define restaurant-wide default time slots (local time strings HH:MM)
    TIME_SLOTS: List[str] = [
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
        "22:00",
    ]


settings = Settings()


```

```python
from typing import AsyncGenerator

from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
from sqlalchemy.orm import DeclarativeBase

from .config import settings


class Base(DeclarativeBase):
    pass


engine = create_async_engine(settings.DB_URL, echo=False, future=True)
AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)


async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with AsyncSessionLocal() as session:
        yield session


async def init_db() -> None:
    # Import models inside function to avoid circular imports
    from .models import Restaurant, Booking  # noqa: F401

    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    # Seed default restaurant with id=1 if not exists
    from sqlalchemy import select

    async with AsyncSessionLocal() as session:
        result = await session.execute(select(Restaurant).where(Restaurant.id == 1))
        restaurant = result.scalar_one_or_none()
        if restaurant is None:
            session.add(Restaurant(id=1, name="Default Restaurant", default_table_count=5))
            await session.commit()


```

```python
from sqlalchemy import ForeignKey, Integer, String, Date, UniqueConstraint
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .db import Base


class Restaurant(Base):
    __tablename__ = "restaurants"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    default_table_count: Mapped[int] = mapped_column(Integer, nullable=False, default=5)

    bookings: Mapped[list["Booking"]] = relationship("Booking", back_populates="restaurant")


class Booking(Base):
    __tablename__ = "bookings"
    __table_args__ = (
        UniqueConstraint("restaurant_id", "date", "time_slot", "client_name", name="uq_booking_dedup"),
    )

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    restaurant_id: Mapped[int] = mapped_column(ForeignKey("restaurants.id", ondelete="CASCADE"), nullable=False)
    date: Mapped[Date] = mapped_column(Date, nullable=False)
    time_slot: Mapped[str] = mapped_column(String(10), nullable=False)
    client_name: Mapped[str] = mapped_column(String(255), nullable=False)

    restaurant: Mapped[Restaurant] = relationship("Restaurant", back_populates="bookings")


```

```python
from datetime import date
from typing import List, Optional

from pydantic import BaseModel, Field


class TokenResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"


class LoginRequest(BaseModel):
    username: str
    password: str


class BookingCreate(BaseModel):
    restaurant_id: int = Field(..., ge=1)
    date: date
    time_slot: str
    client_name: str


class SlotInfo(BaseModel):
    time: str
    booked: int
    free: int


class SlotsResponse(BaseModel):
    restaurant_id: int
    date: date
    slots: List[SlotInfo]


```

```python
from datetime import datetime, timedelta
from typing import Any, Dict

import jwt
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer

from .config import settings


security = HTTPBearer(auto_error=True)


def create_access_token(subject: str, restaurant_id: int, expires_delta: timedelta | None = None) -> str:
    to_encode: Dict[str, Any] = {
        "sub": subject,
        "restaurant_id": restaurant_id,
        "iat": int(datetime.utcnow().timestamp()),
    }
    if expires_delta is None:
        expires_delta = timedelta(hours=8)
    expire = datetime.utcnow() + expires_delta
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, settings.JWT_SECRET, algorithm=settings.JWT_ALGORITHM)
    return encoded_jwt


def decode_token(token: str) -> Dict[str, Any]:
    try:
        payload = jwt.decode(token, settings.JWT_SECRET, algorithms=[settings.JWT_ALGORITHM])
        return payload
    except jwt.PyJWTError as e:
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid token") from e


async def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)) -> Dict[str, Any]:
    token = credentials.credentials
    payload = decode_token(token)
    return payload


```

```python
import json
from typing import Any, Optional

from redis.asyncio import Redis

from .config import settings


def get_redis_client() -> Redis:
    return Redis.from_url(settings.REDIS_URL, encoding="utf-8", decode_responses=True)


async def get_cached_slots(restaurant_id: int, date_str: str) -> Optional[list[dict[str, Any]]]:
    redis = get_redis_client()
    key = f"slots:{restaurant_id}:{date_str}"
    data = await redis.get(key)
    await redis.aclose()
    if data:
        try:
            return json.loads(data)
        except Exception:
            return None
    return None


async def set_cached_slots(restaurant_id: int, date_str: str, slots: list[dict[str, Any]], ttl_seconds: int = 3600) -> None:
    redis = get_redis_client()
    key = f"slots:{restaurant_id}:{date_str}"
    await redis.set(key, json.dumps(slots), ex=ttl_seconds)
    await redis.aclose()


```

```python
from fastapi import APIRouter

from .auth import router as auth_router
from .bookings import router as bookings_router


api_router = APIRouter()
api_router.include_router(auth_router, prefix="/auth", tags=["auth"])
api_router.include_router(bookings_router, prefix="/bookings", tags=["bookings"])


```

```python
from fastapi import APIRouter, HTTPException, status

from ..auth import create_access_token
from ..config import settings
from ..schemas import LoginRequest, TokenResponse


router = APIRouter()


@router.post("/login", response_model=TokenResponse)
async def login(payload: LoginRequest):
    if payload.username != settings.ADMIN_USERNAME or payload.password != settings.ADMIN_PASSWORD:
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid credentials")

    # For v1 we always map to restaurant_id=1
    access_token = create_access_token(subject=payload.username, restaurant_id=1)
    return TokenResponse(access_token=access_token)


```

```python
from collections import defaultdict
from datetime import date
from typing import Dict, List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import Select, func, select
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth import get_current_user
from ..cache import get_cached_slots, set_cached_slots
from ..config import settings
from ..db import get_db
from ..models import Booking, Restaurant
from ..schemas import BookingCreate, SlotInfo, SlotsResponse


router = APIRouter()


@router.get("/{restaurant_id}/{date}", response_model=SlotsResponse)
async def get_slots(restaurant_id: int, date: str, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    try:
        query_date = date  # keep as string for cache key
        # Check cache first
        cached = await get_cached_slots(restaurant_id, query_date)
        if cached is not None:
            return SlotsResponse(restaurant_id=restaurant_id, date=date, slots=[SlotInfo(**s) for s in cached])

        # Build from DB
        # Get restaurant to know default_table_count
        restaurant = await db.get(Restaurant, restaurant_id)
        if restaurant is None:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

        stmt: Select = (
            select(Booking.time_slot, func.count(Booking.id))
            .where(Booking.restaurant_id == restaurant_id)
            .where(Booking.date == date)  # SQLAlchemy will cast string to date
            .group_by(Booking.time_slot)
        )
        result = await db.execute(stmt)
        counts: Dict[str, int] = {row[0]: int(row[1]) for row in result.all()}

        slots: List[dict] = []
        for t in settings.TIME_SLOTS:
            booked = counts.get(t, 0)
            free = max(restaurant.default_table_count - booked, 0)
            slots.append({"time": t, "booked": booked, "free": free})

        # Cache result
        await set_cached_slots(restaurant_id, query_date, slots)

        return SlotsResponse(restaurant_id=restaurant_id, date=date, slots=[SlotInfo(**s) for s in slots])
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("", status_code=201)
async def create_booking(payload: BookingCreate, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    # Ensure restaurant exists
    restaurant = await db.get(Restaurant, payload.restaurant_id)
    if restaurant is None:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

    # Check if time slot is valid
    if payload.time_slot not in settings.TIME_SLOTS:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid time slot")

    # Count existing bookings
    stmt: Select = (
        select(func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .where(Booking.time_slot == payload.time_slot)
    )
    result = await db.execute(stmt)
    current_count = int(result.scalar() or 0)
    if current_count >= restaurant.default_table_count:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="No free tables for selected slot")

    booking = Booking(
        restaurant_id=payload.restaurant_id,
        date=payload.date,
        time_slot=payload.time_slot,
        client_name=payload.client_name,
    )
    db.add(booking)
    await db.commit()

    # Invalidate/update cache by recomputing slots for that date
    # Simpler: recompute and set cache now
    stmt_counts: Select = (
        select(Booking.time_slot, func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .group_by(Booking.time_slot)
    )
    res = await db.execute(stmt_counts)
    counts = {row[0]: int(row[1]) for row in res.all()}
    slots = []
    for t in settings.TIME_SLOTS:
        booked = counts.get(t, 0)
        free = max(restaurant.default_table_count - booked, 0)
        slots.append({"time": t, "booked": booked, "free": free})

    await set_cached_slots(payload.restaurant_id, str(payload.date), slots)

    return {"status": "ok", "booking_id": booking.id}


```

```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package.json package-lock.json* .npmrc* ./

RUN npm ci || npm install

COPY . .

EXPOSE 5173

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]


```

```json
{
  "name": "restaurant-crm-frontend",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview --host"
  },
  "dependencies": {
    "axios": "^1.7.2",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.24.0"
  },
  "devDependencies": {
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@types/node": "^20.14.2",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.39",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.4.5",
    "vite": "^5.3.1"
  }
}


```

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant CRM</title>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
  </html>


```

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    './index.html',
    './src/**/*.{ts,tsx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}


```

```javascript
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


```

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  @apply text-gray-900;
}

.btn {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-black text-white hover:bg-gray-800 transition-colors;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200;
}

.input {
  @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-300;
}

.modal-backdrop {
  @apply fixed inset-0 bg-black/30 flex items-center justify-center z-50;
}

.modal {
  @apply bg-white rounded-lg p-6 w-full max-w-md shadow-lg;
}


```

```typescriptreact
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
)


```

```typescriptreact
import { Navigate, Route, Routes } from 'react-router-dom'
import LoginPage from './pages/Login'
import BookingsPage from './pages/Bookings'
import SettingsPage from './pages/Settings'
import DashboardPage from './pages/Dashboard'
import Layout from './components/Layout'

function ProtectedRoute({ children }: { children: JSX.Element }) {
  const token = localStorage.getItem('token')
  if (!token) return <Navigate to="/login" replace />
  return children
}

export default function App() {
  return (
    <Routes>
      <Route path="/login" element={<LoginPage />} />
      <Route
        path="/"
        element={
          <ProtectedRoute>
            <Layout />
          </ProtectedRoute>
        }
      >
        <Route index element={<Navigate to="/bookings" replace />} />
        <Route path="bookings" element={<BookingsPage />} />
        <Route path="settings" element={<SettingsPage />} />
        <Route path="dashboard" element={<DashboardPage />} />
      </Route>
      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  )
}


```

```typescriptreact
import { Link, NavLink, Outlet, useNavigate } from 'react-router-dom'

export default function Layout() {
  const navigate = useNavigate()

  const logout = () => {
    localStorage.removeItem('token')
    navigate('/login')
  }

  return (
    <div className="min-h-screen flex">
      <aside className="w-64 bg-white border-r border-gray-200 p-6">
        <div className="mb-8">
          <Link to="/" className="text-xl font-semibold">CRM</Link>
        </div>
        <nav className="space-y-2">
          <NavLink to="/bookings" className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</NavLink>
          <NavLink to="/settings" className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / –ù–∞—Å—Ç—Ä–æ–π–∫–∏</NavLink>
          <NavLink to="/dashboard" className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–î–∞—à–±–æ—Ä–¥</NavLink>
        </nav>
        <button onClick={logout} className="btn mt-8 w-full">–í—ã–π—Ç–∏</button>
      </aside>
      <main className="flex-1 p-8">
        <Outlet />
      </main>
    </div>
  )
}


```

```typescriptreact
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

export default function LoginPage() {
  const [username, setUsername] = useState('admin')
  const [password, setPassword] = useState('password123')
  const [error, setError] = useState('')
  const navigate = useNavigate()

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    try {
      const res = await axios.post(`${API_URL}/auth/login`, { username, password })
      localStorage.setItem('token', res.data.access_token)
      navigate('/bookings')
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞')
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <div className="card w-full max-w-sm p-6">
        <h1 className="text-2xl font-semibold mb-6 text-center">–í—Ö–æ–¥ –≤ CRM</h1>
        <form onSubmit={onSubmit} className="space-y-4">
          <div>
            <label className="block text-sm mb-1">–õ–æ–≥–∏–Ω</label>
            <input className="input" value={username} onChange={e => setUsername(e.target.value)} />
          </div>
          <div>
            <label className="block text-sm mb-1">–ü–∞—Ä–æ–ª—å</label>
            <input className="input" type="password" value={password} onChange={e => setPassword(e.target.value)} />
          </div>
          {error && <div className="text-red-600 text-sm">{error}</div>}
          <button type="submit" className="btn w-full">–í–æ–π—Ç–∏</button>
        </form>
      </div>
    </div>
  )
}


```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        { restaurant_id: restaurantId, date, time_slot: selectedTime, client_name: clientName },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-4 gap-6">
      <div className="col-span-1 card p-4">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <input type="date" className="input" value={date} onChange={e => setDate(e.target.value)} />
      </div>
      <div className="col-span-3 card p-4">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</h3>
            <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input className="input" value={clientName} onChange={e => setClientName(e.target.value)} />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <input className="input" type="date" value={date} onChange={e => setDate(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è</label>
                  <input className="input" value={selectedTime} onChange={e => setSelectedTime(e.target.value)} />
                </div>
              </div>
              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName || !selectedTime}>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}


```

```typescriptreact
export default function SettingsPage() {
  return (
    <div className="card p-6">
      <h1 className="text-2xl font-semibold mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <p className="text-gray-600">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
    </div>
  )
}


```

```typescriptreact
export default function DashboardPage() {
  return (
    <div className="card p-6">
      <h1 className="text-2xl font-semibold mb-2">–î–∞—à–±–æ—Ä–¥</h1>
      <p className="text-gray-600">–î–∞—à–±–æ—Ä–¥ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
    </div>
  )
}


```

```jsonc
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "baseUrl": "."
  },
  "include": ["src"]
}


```

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: 5173,
  },
})


```

I created the full project scaffold: Docker Compose, FastAPI backend with JWT, PostgreSQL and Redis integration, and a React+Vite+Tailwind frontend. Next, I‚Äôll finalize minor backend fixes (ID refresh, date parsing), add a Python package init, and include a README with run instructions and API docs. Proceeding to implement these updates.

```python
# Makes app a Python package


```

```python
from datetime import datetime
from typing import Dict, List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import Select, func, select
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth import get_current_user
from ..cache import get_cached_slots, set_cached_slots
from ..config import settings
from ..db import get_db
from ..models import Booking, Restaurant
from ..schemas import BookingCreate, SlotInfo, SlotsResponse


router = APIRouter()


@router.get("/{restaurant_id}/{date}", response_model=SlotsResponse)
async def get_slots(restaurant_id: int, date: str, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    try:
        date_str = date
        try:
            parsed_date = datetime.strptime(date_str, "%Y-%m-%d").date()
        except ValueError:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid date format, expected YYYY-MM-DD")
        query_date = date_str  # keep as string for cache key
        # Check cache first
        cached = await get_cached_slots(restaurant_id, query_date)
        if cached is not None:
            return SlotsResponse(restaurant_id=restaurant_id, date=parsed_date, slots=[SlotInfo(**s) for s in cached])

        # Build from DB
        # Get restaurant to know default_table_count
        restaurant = await db.get(Restaurant, restaurant_id)
        if restaurant is None:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

        stmt: Select = (
            select(Booking.time_slot, func.count(Booking.id))
            .where(Booking.restaurant_id == restaurant_id)
            .where(Booking.date == parsed_date)
            .group_by(Booking.time_slot)
        )
        result = await db.execute(stmt)
        counts: Dict[str, int] = {row[0]: int(row[1]) for row in result.all()}

        slots: List[dict] = []
        for t in settings.TIME_SLOTS:
            booked = counts.get(t, 0)
            free = max(restaurant.default_table_count - booked, 0)
            slots.append({"time": t, "booked": booked, "free": free})

        # Cache result
        await set_cached_slots(restaurant_id, query_date, slots)

        return SlotsResponse(restaurant_id=restaurant_id, date=parsed_date, slots=[SlotInfo(**s) for s in slots])
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("", status_code=201)
async def create_booking(payload: BookingCreate, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    # Ensure restaurant exists
    restaurant = await db.get(Restaurant, payload.restaurant_id)
    if restaurant is None:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

    # Check if time slot is valid
    if payload.time_slot not in settings.TIME_SLOTS:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid time slot")

    # Count existing bookings
    stmt: Select = (
        select(func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .where(Booking.time_slot == payload.time_slot)
    )
    result = await db.execute(stmt)
    current_count = int(result.scalar() or 0)
    if current_count >= restaurant.default_table_count:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="No free tables for selected slot")

    booking = Booking(
        restaurant_id=payload.restaurant_id,
        date=payload.date,
        time_slot=payload.time_slot,
        client_name=payload.client_name,
    )
    db.add(booking)
    await db.commit()
    await db.refresh(booking)

    # Invalidate/update cache by recomputing slots for that date
    # Simpler: recompute and set cache now
    stmt_counts: Select = (
        select(Booking.time_slot, func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .group_by(Booking.time_slot)
    )
    res = await db.execute(stmt_counts)
    counts = {row[0]: int(row[1]) for row in res.all()}
    slots = []
    for t in settings.TIME_SLOTS:
        booked = counts.get(t, 0)
        free = max(restaurant.default_table_count - booked, 0)
        slots.append({"time": t, "booked": booked, "free": free})

    await set_cached_slots(payload.restaurant_id, str(payload.date), slots)

    return {"status": "ok", "booking_id": booking.id}


```

```markdown
*** Begin Patch
*** Add File: /Users/alexgl/Documents/Projects/Snapyfit/0_AI_hostes_RND/CRM_Proto_v2/README.md
+# Restaurant CRM (v1)

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind), –±—ç–∫–µ–Ω–¥ (FastAPI), PostgreSQL, Redis. –ó–∞–ø—É—Å–∫ –≤ Docker Compose. –ï—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT), –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker-compose up --build
```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:5173`.
4. –í–æ–π–¥–∏—Ç–µ: –ª–æ–≥–∏–Ω `admin`, –ø–∞—Ä–æ–ª—å `password123`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `frontend/` ‚Äî React + Vite + Tailwind UI
- `backend/` ‚Äî FastAPI + SQLAlchemy + Redis + JWT
- `docker-compose.yml` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

- Backend
  - `DB_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db`)
  - `REDIS_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://redis:6379/0`)
  - `JWT_SECRET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `supersecretjwt`)
  - `JWT_ALGORITHM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `HS256`)
  - `ADMIN_USERNAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`)
  - `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `password123`)
  - `FRONTEND_ORIGIN` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:5173`)
- Frontend
  - `VITE_API_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:

- `restaurants`
  - `id` (PK)
  - `name`
  - `default_table_count` (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
- `bookings`
  - `id` (PK)
  - `restaurant_id` (FK -> restaurants.id)
  - `date` (date)
  - `time_slot` (string, –Ω–∞–ø—Ä–∏–º–µ—Ä `18:00`)
  - `client_name` (string)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω `id=1` —Å `default_table_count=5`.

## API

–ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`

- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  - `POST /auth/login`
    - –í—Ö–æ–¥: `{ "username": "admin", "password": "password123" }`
    - –û—Ç–≤–µ—Ç: `{ "access_token": "...", "token_type": "bearer" }`
- –°–ª–æ—Ç—ã –ø–æ –¥–∞—Ç–µ
  - `GET /bookings/{restaurant_id}/{date}` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –ü—Ä–∏–º–µ—Ä: `/bookings/1/2025-01-01`
  - –û—Ç–≤–µ—Ç: `{ restaurant_id, date, slots: [{ time, booked, free }] }`
  - –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –∫–ª—é—á–æ–º `slots:{restaurant_id}:{date}` –Ω–∞ 1 —á–∞—Å
- –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  - `POST /bookings` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –í—Ö–æ–¥: `{ "restaurant_id": 1, "date": "2025-01-01", "time_slot": "18:00", "client_name": "–ò–≤–∞–Ω" }`
  - –û—Ç–≤–µ—Ç: `{ "status": "ok", "booking_id": <id> }`

## –ö—ç—à Redis

- –ö–ª—é—á–∏: `slots:{restaurant_id}:{date}`
- –ó–Ω–∞—á–µ–Ω–∏–µ: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º `{ time: "18:00", booked: 2, free: 3 }`
- TTL: 3600 —Å–µ–∫—É–Ω–¥

## UI

- –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
- –°–∞–π–¥–±–∞—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –î–∞—à–±–æ—Ä–¥
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ —Å –º–æ–¥–∞–ª–∫–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: —Ç–æ–∫–µ–Ω –≤–∫–ª—é—á–∞–µ—Ç `restaurant_id`, —Ç–∞–±–ª–∏—Ü–∞ `restaurants`, —Å–≤—è–∑—å —Å `bookings`.
- –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–∏, –∞ —Ç–∞–∫–∂–µ RBAC –∏ —Ä–µ–∞–ª—å–Ω—ã–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ª–æ–≥–∏–Ω.

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ Docker

- Backend
  ```bash
  cd backend
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  export DB_URL=postgresql+asyncpg://crm_user:crm_password@localhost:5432/crm_db
  export REDIS_URL=redis://localhost:6379/0
  uvicorn app.main:app --reload
  ```
- Frontend
  ```bash
  cd frontend
  npm i
  npm run dev
  ```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

*** End Patch
```

```markdown
### Restaurant CRM (v1)

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind), –±—ç–∫–µ–Ω–¥ (FastAPI), PostgreSQL, Redis. –ó–∞–ø—É—Å–∫ –≤ Docker Compose. –ï—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT), –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker-compose up --build
```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:5173`.
4. –í–æ–π–¥–∏—Ç–µ: –ª–æ–≥–∏–Ω `admin`, –ø–∞—Ä–æ–ª—å `password123`.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `frontend/` ‚Äî React + Vite + Tailwind UI
- `backend/` ‚Äî FastAPI + SQLAlchemy + Redis + JWT
- `docker-compose.yml` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

- **Backend**
  - `DB_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db`)
  - `REDIS_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://redis:6379/0`)
  - `JWT_SECRET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `supersecretjwt`)
  - `JWT_ALGORITHM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `HS256`)
  - `ADMIN_USERNAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`)
  - `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `password123`)
  - `FRONTEND_ORIGIN` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:5173`)
- **Frontend**
  - `VITE_API_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:

- `restaurants`
  - `id` (PK)
  - `name`
  - `default_table_count` (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
- `bookings`
  - `id` (PK)
  - `restaurant_id` (FK -> restaurants.id)
  - `date` (date)
  - `time_slot` (string, –Ω–∞–ø—Ä–∏–º–µ—Ä `18:00`)
  - `client_name` (string)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω `id=1` —Å `default_table_count=5`.

### API

–ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
  - `POST /auth/login`
    - –í—Ö–æ–¥: `{ "username": "admin", "password": "password123" }`
    - –û—Ç–≤–µ—Ç: `{ "access_token": "...", "token_type": "bearer" }`
- **–°–ª–æ—Ç—ã –ø–æ –¥–∞—Ç–µ**
  - `GET /bookings/{restaurant_id}/{date}` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –ü—Ä–∏–º–µ—Ä: `/bookings/1/2025-01-01`
  - –û—Ç–≤–µ—Ç: `{ restaurant_id, date, slots: [{ time, booked, free }] }`
  - –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –∫–ª—é—á–æ–º `slots:{restaurant_id}:{date}` –Ω–∞ 1 —á–∞—Å
- **–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
  - `POST /bookings` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –í—Ö–æ–¥: `{ "restaurant_id": 1, "date": "2025-01-01", "time_slot": "18:00", "client_name": "–ò–≤–∞–Ω" }`
  - –û—Ç–≤–µ—Ç: `{ "status": "ok", "booking_id": <id> }`

### –ö—ç—à Redis

- –ö–ª—é—á–∏: `slots:{restaurant_id}:{date}`
- –ó–Ω–∞—á–µ–Ω–∏–µ: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º `{ time: "18:00", booked: 2, free: 3 }`
- TTL: 3600 —Å–µ–∫—É–Ω–¥

### UI

- –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
- –°–∞–π–¥–±–∞—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –î–∞—à–±–æ—Ä–¥
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ —Å –º–æ–¥–∞–ª–∫–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: —Ç–æ–∫–µ–Ω –≤–∫–ª—é—á–∞–µ—Ç `restaurant_id`, —Ç–∞–±–ª–∏—Ü–∞ `restaurants`, —Å–≤—è–∑—å —Å `bookings`.
- –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–∏, –∞ —Ç–∞–∫–∂–µ RBAC –∏ —Ä–µ–∞–ª—å–Ω—ã–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ª–æ–≥–∏–Ω.

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ Docker

- Backend
  ```bash
  cd backend
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  export DB_URL=postgresql+asyncpg://crm_user:crm_password@localhost:5432/crm_db
  export REDIS_URL=redis://localhost:6379/0
  uvicorn app.main:app --reload
  ```
- Frontend
  ```bash
  cd frontend
  npm i
  npm run dev
  ```

### –õ–∏—Ü–µ–Ω–∑–∏—è

MIT


```

```python
from datetime import date


def date_to_str(d: date) -> str:
    return d.isoformat()


```

```json
{
  "name": "restaurant-crm-frontend",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview --host"
  },
  "dependencies": {
    "axios": "^1.7.2",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.24.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.1",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@types/node": "^20.14.2",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.39",
    "tailwindcss": "^3.4.4",
    "typescript": "^5.4.5",
    "vite": "^5.3.1"
  }
}


```

I finished scaffolding backend and frontend, added JWT auth, DB models, Redis caching, and UI pages. I fixed date parsing and ensured booking ID returns correctly. Now I'll attempt to build and start the stack in Docker to validate everything runs.

- –†–∞–∑–≤–µ—Ä–Ω—É–ª –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫: FastAPI + PostgreSQL + Redis + React/Vite/Tailwind, —Å Docker Compose.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–ª JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–∞–¥–º–∏–Ω—Å–∫–∏–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å), —Å–ª–æ—Ç—ã —Å –∫—ç—à–µ–º –≤ Redis, —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ–π UI —Å —Å–∞–π–¥–±–∞—Ä–æ–º, –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º –∏ –º–æ–¥–∞–ª–∫–æ–π.

### –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å
- –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
  - ```bash
    docker-compose up --build
    ```
- –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ `http://localhost:5173`
- –õ–æ–≥–∏–Ω: `admin`, –ü–∞—Ä–æ–ª—å: `password123`

### –ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å
- –ë—ç–∫–µ–Ω–¥ (FastAPI) –Ω–∞ `http://localhost:8000`
  - CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è `http://localhost:5173`
  - –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º –ë–î –∏ —Å–∏–¥ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ `id=1` —Å 5 —Å—Ç–æ–ª–∞–º–∏
  - Redis-–∫—ç—à –¥–ª—è –∫–ª—é—á–µ–π `slots:{restaurant_id}:{date}`, TTL 1 —á–∞—Å
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind)
  - –°—Ç—Ä–∞–Ω–∏—Ü—ã: `Bookings`, `Settings` (–∑–∞–≥–ª—É—à–∫–∞), `Dashboard` (–∑–∞–≥–ª—É—à–∫–∞)
  - –°–∞–π–¥–±–∞—Ä, —Å–≤–µ—Ç–ª–∞—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–µ–º–∞, –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### API
- –ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –æ—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:8000/docs`
- –ú–µ—Ç–æ–¥—ã:
  - POST `/auth/login` ‚Üí `{access_token, token_type}`
  - GET `/bookings/{restaurant_id}/{date}` ‚Üí —Å–ª–æ—Ç—ã (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis ‚Üí PostgreSQL ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ Redis)
  - POST `/bookings` ‚Üí —Å–æ–∑–¥–∞—ë—Ç –±—Ä–æ–Ω—å, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ –±—É–¥—É—â–µ–µ
- –í–ª–æ–∂–∏–ª `restaurant_id` –≤ JWT, —Ç–∞–±–ª–∏—Ü–∞ `restaurants` –∏ —Å–≤—è–∑—å `bookings` —É–∂–µ –µ—Å—Ç—å ‚Äî –≥–æ—Ç–æ–≤–æ –∫ –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–æ–ª—è–º.

- –ö–∞–∫ –≤—ã–∫–ª—é—á–∏—Ç—å:
  - ```bash
    docker-compose down -v
    ```

- –î–æ—Å—Ç—É–ø–Ω—ã–µ ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω—ã –≤ `README.md` (`DB_URL`, `REDIS_URL`, `JWT_SECRET`, `ADMIN_*`, `VITE_API_URL`, –∏ —Ç.–¥.).

- –ü—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–∫–∞–ª—å–Ω–æ: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—Ç; —Å–ª–æ—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è.

- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–æ–±–∞–≤–ª—é –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic), —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –∏ SSR.

```plaintext
- –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ `http://localhost:5173`
- –õ–æ–≥–∏–Ω: `admin`, –ü–∞—Ä–æ–ª—å: `password123`

### –ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å
- –ë—ç–∫–µ–Ω–¥ (FastAPI) –Ω–∞ `http://localhost:8000`
  - CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è `http://localhost:5173`
  - –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º –ë–î –∏ —Å–∏–¥ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ `id=1` —Å 5 —Å—Ç–æ–ª–∞–º–∏
  - Redis-–∫—ç—à –¥–ª—è –∫–ª—é—á–µ–π `slots:{restaurant_id}:{date}`, TTL 1 —á–∞—Å
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind)
  - –°—Ç—Ä–∞–Ω–∏—Ü—ã: `Bookings`, `Settings` (–∑–∞–≥–ª—É—à–∫–∞), `Dashboard` (–∑–∞–≥–ª—É—à–∫–∞)
  - –°–∞–π–¥–±–∞—Ä, —Å–≤–µ—Ç–ª–∞—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–µ–º–∞, –º–æ–¥–∞–ª–∫–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### API
- –ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –æ—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:8000/docs`
- –ú–µ—Ç–æ–¥—ã:
  - POST `/auth/login` ‚Üí `{access_token, token_type}`
  - GET `/bookings/{restaurant_id}/{date}` ‚Üí —Å–ª–æ—Ç—ã (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis ‚Üí PostgreSQL ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ Redis)
  - POST `/bookings` ‚Üí —Å–æ–∑–¥–∞—ë—Ç –±—Ä–æ–Ω—å, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ –±—É–¥—É—â–µ–µ
- –í–ª–æ–∂–∏–ª `restaurant_id` –≤ JWT, —Ç–∞–±–ª–∏—Ü–∞ `restaurants` –∏ —Å–≤—è–∑—å `bookings` —É–∂–µ –µ—Å—Ç—å ‚Äî –≥–æ—Ç–æ–≤–æ –∫ –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–æ–ª—è–º.

- –ö–∞–∫ –≤—ã–∫–ª—é—á–∏—Ç—å:
  - ```bash
    docker-compose down -v
```

---

**User**

–û—Ñ–∏–≥–µ–Ω–Ω–æ! –î–∞–≤–∞–π –ø—Ä–∞–≤–∫–∏ –ø–æ –°—Ç—Ä–∞–Ω–∏—á–∫–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:
1) –°–ø–∏—Å–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º —Å—Ç–æ–ª–±–∏–∫–æ–º —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç - –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É
2) –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã —Å–¥–µ–ª–∞–π –∫–∞–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä—è–º
3) –í–º–µ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –≤–º–µ—Å—Ç–æ "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞–ø–∏—à–∏ "–î–æ–±–∞–≤–∏—Ç—å"

---

**Cursor**

I'll implement the requested UI changes:
- Add a custom calendar component and use it instead of the native date input.
- Render the slot list as a single vertical column with full-width items.
- Replace button labels from "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å" to "–î–æ–±–∞–≤–∏—Ç—å".
After editing, I'll rebuild the frontend container to apply changes.

```typescriptreact
import { useMemo, useState } from 'react'

type Props = {
  value: string
  onChange: (next: string) => void
}

function toISO(d: Date) {
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}

export default function Calendar({ value, onChange }: Props) {
  const initial = useMemo(() => (value ? new Date(value + 'T00:00:00') : new Date()), [value])
  const [view, setView] = useState<Date>(new Date(initial.getFullYear(), initial.getMonth(), 1))

  const selectedISO = value
  const todayISO = toISO(new Date())

  const monthLabel = view.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })

  const daysMatrix = useMemo(() => {
    const y = view.getFullYear()
    const m = view.getMonth()
    const first = new Date(y, m, 1)
    // Monday-first index: 0..6 where 0 is Monday
    const firstDayIdx = (first.getDay() + 6) % 7
    const daysInMonth = new Date(y, m + 1, 0).getDate()
    const cells: Array<{ iso: string | null; day: number | null }> = []

    // leading blanks
    for (let i = 0; i < firstDayIdx; i++) cells.push({ iso: null, day: null })
    // days
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(y, m, d)
      cells.push({ iso: toISO(date), day: d })
    }
    // trailing to complete weeks
    while (cells.length % 7 !== 0) cells.push({ iso: null, day: null })
    return cells
  }, [view])

  const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å']

  const prevMonth = () => setView(new Date(view.getFullYear(), view.getMonth() - 1, 1))
  const nextMonth = () => setView(new Date(view.getFullYear(), view.getMonth() + 1, 1))

  return (
    <div className="card p-3">
      <div className="flex items-center justify-between mb-2">
        <button className="px-2 py-1 rounded-md border hover:bg-gray-50" onClick={prevMonth}>¬´</button>
        <div className="font-medium capitalize">{monthLabel}</div>
        <button className="px-2 py-1 rounded-md border hover:bg-gray-50" onClick={nextMonth}>¬ª</button>
      </div>
      <div className="grid grid-cols-7 gap-1 text-xs text-gray-500 mb-1">
        {weekdays.map(w => (
          <div className="text-center" key={w}>{w}</div>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-1">
        {daysMatrix.map((cell, idx) => {
          if (!cell.iso) return <div key={idx} className="h-9" />
          const isSelected = cell.iso === selectedISO
          const isToday = cell.iso === todayISO
          return (
            <button
              key={idx}
              onClick={() => onChange(cell.iso!)}
              className={
                `h-9 rounded-md text-sm flex items-center justify-center border ` +
                (isSelected ? 'bg-black text-white border-black' : 'bg-white hover:bg-gray-50 border-gray-200') +
                (isToday && !isSelected ? ' ring-1 ring-gray-300' : '')
              }
            >
              {cell.day}
            </button>
          )
        })}
      </div>
    </div>
  )
}


```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        { restaurant_id: restaurantId, date, time_slot: selectedTime, client_name: clientName },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-4 gap-6">
      <div className="col-span-1">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="col-span-3 card p-4">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between w-full">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</h3>
            <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input className="input" value={clientName} onChange={e => setClientName(e.target.value)} />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è</label>
                  <input className="input" value={selectedTime} onChange={e => setSelectedTime(e.target.value)} />
                </div>
              </div>
              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName || !selectedTime}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}


```

–ì–æ—Ç–æ–≤–æ. –û–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

–°–¥–µ–ª–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏:
- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤: —Ç–µ–ø–µ—Ä—å –æ–¥–∏–Ω —Å—Ç–æ–ª–±–µ—Ü, –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É.
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –¥–æ–±–∞–≤–ª–µ–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `Calendar` —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –º–µ—Å—è—Ü–µ–≤; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏.
- –¢–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫: –∑–∞–º–µ–Ω–∏–ª ¬´–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª –Ω–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö.

–ß—Ç–æ –≤–∞–∂–Ω–æ:
- –ò–∑–º–µ–Ω–µ–Ω—ã —Ñ–∞–π–ª—ã: `src/pages/Bookings.tsx`, –¥–æ–±–∞–≤–ª–µ–Ω `src/components/Calendar.tsx`.
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ; Vite –ø–æ–¥–Ω—è—Ç –Ω–∞ `http://localhost:5173`.

–ü—Ä–æ–≤–µ—Ä—å:
- –û—Ç–∫—Ä–æ–π `/bookings`, –≤—ã–±–µ—Ä–∏ –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ —Å–ª–µ–≤–∞, –ø—Ä–∞–≤–µ–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ. –í —Å–ª–æ—Ç–∞—Ö –∫–Ω–æ–ø–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É. –í –º–æ–¥–∞–ª–∫–µ —Ç–∞–∫–∂–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –∏ –∫–Ω–æ–ø–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª —Å–æ–∑–¥–∞—ë—Ç –±—Ä–æ–Ω—å.

---

**User**

—É –º–µ–Ω—è –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å —á—Ç–æ-—Ç–æ. –¢–∞–º –≤ –¥–æ–∫–µ—Ä–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –±—ã–ª–æ, –º–æ–∂–µ—Ç –µ–≥–æ –ø–µ—Ä–µ–±–∏–ª–¥–∏—Ç—å –Ω–∞–¥–æ?

---

**Cursor**

–ü–µ—Ä–µ—Å–æ–±–µ—Ä—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—é –ª–æ–≥–∏ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

–î–∞, –≤ –¥–æ–∫–µ—Ä–µ —Ñ—Ä–æ–Ω—Ç –º–æ–≥ –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç—å —Å–≤–µ–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –Ø –ø–µ—Ä–µ—Å–æ–±—Ä–∞–ª –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ `http://localhost:5173` (–∏–Ω–æ–≥–¥–∞ —Å –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –∫—ç—à–∞: Cmd+Shift+R). –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
- —Å–ª–µ–≤–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å,
- —Å–ø—Ä–∞–≤–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤,
- –∫–Ω–æ–ø–∫–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª.

---

**User**

–î–∞ —Å—É–ø–µ—Ä! –ú–æ–∂–µ—à—å –µ—â–µ –≤–µ—Ä—Å—Ç–∫—É –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å—Ä–∞–∑—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∂–µ

---

**Cursor**

–í–Ω–µ—Å—É –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: —Å–¥–µ–ª–∞—é —Å–∞–π–¥–±–∞—Ä –º–æ–±–∏–ª—å–Ω—ã–º (–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é –∏ –≤—ã–µ–∑–∂–∞—é—â—É—é –ø–∞–Ω–µ–ª—å), –∞ —Å–µ—Ç–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π ‚Äî –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ —á–µ—Ç—ã—Ä–µ –Ω–∞ –±–æ–ª—å—à–∏—Ö. –ó–∞—Ç–µ–º –ø–µ—Ä–µ—Å–æ–±–µ—Ä—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

```typescriptreact
import { Link, NavLink, Outlet, useNavigate } from 'react-router-dom'
import { useState } from 'react'

export default function Layout() {
  const navigate = useNavigate()
  const [open, setOpen] = useState(false)

  const logout = () => {
    localStorage.removeItem('token')
    navigate('/login')
  }

  const Nav = (
    <>
      <nav className="space-y-2">
        <NavLink to="/bookings" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</NavLink>
        <NavLink to="/settings" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / –ù–∞—Å—Ç—Ä–æ–π–∫–∏</NavLink>
        <NavLink to="/dashboard" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–î–∞—à–±–æ—Ä–¥</NavLink>
      </nav>
      <button onClick={logout} className="btn mt-8 w-full">–í—ã–π—Ç–∏</button>
    </>
  )

  return (
    <div className="min-h-screen flex">
      {/* Mobile header */}
      <div className="md:hidden fixed top-0 inset-x-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-40">
        <button aria-label="–ú–µ–Ω—é" className="px-3 py-2 rounded-md border hover:bg-gray-50" onClick={() => setOpen(v => !v)}>‚ò∞</button>
        <Link to="/" className="text-lg font-semibold">CRM</Link>
        <div className="w-10" />
      </div>

      {/* Sidebar */}
      <aside className="hidden md:block w-64 bg-white border-r border-gray-200 p-6">
        <div className="mb-8">
          <Link to="/" className="text-xl font-semibold">CRM</Link>
        </div>
        {Nav}
      </aside>

      {/* Mobile drawer */}
      {open && (
        <div className="md:hidden fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/30" onClick={() => setOpen(false)} />
          <div className="absolute left-0 top-0 bottom-0 w-72 bg-white border-r border-gray-200 p-6">
            <div className="mb-6 flex items-center justify-between">
              <Link to="/" className="text-xl font-semibold" onClick={() => setOpen(false)}>CRM</Link>
              <button className="px-2 py-1 rounded-md border hover:bg-gray-50" onClick={() => setOpen(false)}>‚úï</button>
            </div>
            {Nav}
          </div>
        </div>
      )}

      {/* Main */}
      <main className="flex-1 p-4 md:p-8 w-full md:ml-0 pt-16 md:pt-0">
        <Outlet />
      </main>
    </div>
  )
}


```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        { restaurant_id: restaurantId, date, time_slot: selectedTime, client_name: clientName },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between w-full">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</h3>
              <div className="space-y-3">
              <div>
                <label className="block text-sm mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input className="input" value={clientName} onChange={e => setClientName(e.target.value)} />
              </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è</label>
                  <input className="input" value={selectedTime} onChange={e => setSelectedTime(e.target.value)} />
                </div>
              </div>
              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName || !selectedTime}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}


```

–ì–æ—Ç–æ–≤–æ. –Ø –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ:
- –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –º–µ–Ω—é; —Å–∞–π–¥–±–∞—Ä —Ç–µ–ø–µ—Ä—å –∫–∞–∫ –≤—ã–µ–∑–∂–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö.
- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–º–µ–µ—Ç –æ—Ç—Å—Ç—É–ø –æ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö.
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–≤–µ—Ä—Ö—É, —Å–ª–æ—Ç—ã –Ω–∏–∂–µ; –≤ –º–æ–¥–∞–ª–∫–µ —Å–µ—Ç–∫–∞ –ø–æ–ª–µ–π –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö.

–ß—Ç–æ –æ–±–Ω–æ–≤–∏–ª:
- `src/components/Layout.tsx` ‚Äî –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã.
- `src/pages/Bookings.tsx` ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –∏ –º–æ–¥–∞–ª–∫–∞.

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –û–±–Ω–æ–≤–∏ `http://localhost:5173` (Cmd+Shift+R). –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ/—ç–º—É–ª—è—Ç–æ—Ä–µ: –º–µ–Ω—é –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è, —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π, –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É–¥–æ–±–Ω—ã–π.

---

**User**

–°—É–ø–µ—Ä! –¢–µ–ø–µ—Ä—å –≤–∫–ª–∞–¥–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
1) –ü–µ—Ä–µ–∏–º–µ–Ω—É–π –µ–µ —Ç–æ–ª—å–∫–æ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
2) –¢–∞–º –¥–æ–±–∞–≤—å 2 –æ–∫–æ—à–∫–∞ - –æ–¥–Ω–æ –¥–ª—è —á–∞—Ç–∞ (—ç—Ç–æ –±—É–¥–µ—Ç —á–∞—Ç —Å ChatGPT), –∞ —Å–ø—Ä–∞–≤–∞ –≤—Ç–æ—Ä–æ–µ –≥–¥–µ –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ.

–õ–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç —Ç–∞–∫–∞—è:
- —è –ø–æ–ø—Ä–æ—à—É —Ç–µ–±—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ç—É–¥–∞ OpenAI Assistance (–Ø –¥–∞–º ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- —Ç—ã –ø–æ–¥–∫–ª—é—á–∏—à—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤ —ç—Ç–æ—Ç —á–∞—Ç –æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º

–°–ø—Ä–∞–≤–∞ –≤ –æ–∫–æ—à–∫–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ —Å–¥–µ–ª–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –ø–æ–ª–µ–π –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
1) –í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å. –ù–∏–∂–µ - –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–∑ 5 –ª—é–±—ã—Ö –∏–º–µ–Ω –º—É–∂—Å–∫–∏—Ö –∏ –∂–µ–Ω—Å–∫–∏—Ö
2) –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ù–∏–∂–µ - –±–ª–æ–∫ —Å —Ç–µ–º —á—Ç–æ–±—ã –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
3) –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –∏ –Ω–∏–∂–µ –±–ª–æ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.
–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å". –≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –ë–∞–∑–æ–π –î–∞–Ω–Ω—ã—Ö –∏ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ API

---

**Cursor**

I‚Äôm going to implement backend support for restaurant settings (new `restaurant_settings` table, GET/PUT API), update the router to expose endpoints, then update the frontend: rename the nav item to ‚Äú–ù–∞—Å—Ç—Ä–æ–π–∫–∏‚Äù, build a two-pane Settings page with a chat UI placeholder on the left and a settings form on the right, and wire it to the new API. Afterwards I‚Äôll rebuild backend and frontend containers to apply changes.

```python
from sqlalchemy import ForeignKey, Integer, String, Date, UniqueConstraint, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .db import Base


class Restaurant(Base):
    __tablename__ = "restaurants"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    default_table_count: Mapped[int] = mapped_column(Integer, nullable=False, default=5)

    bookings: Mapped[list["Booking"]] = relationship("Booking", back_populates="restaurant")


class Booking(Base):
    __tablename__ = "bookings"
    __table_args__ = (
        UniqueConstraint("restaurant_id", "date", "time_slot", "client_name", name="uq_booking_dedup"),
    )

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    restaurant_id: Mapped[int] = mapped_column(ForeignKey("restaurants.id", ondelete="CASCADE"), nullable=False)
    date: Mapped[Date] = mapped_column(Date, nullable=False)
    time_slot: Mapped[str] = mapped_column(String(10), nullable=False)
    client_name: Mapped[str] = mapped_column(String(255), nullable=False)

    restaurant: Mapped[Restaurant] = relationship("Restaurant", back_populates="bookings")


class RestaurantSettings(Base):
    __tablename__ = "restaurant_settings"

    restaurant_id: Mapped[int] = mapped_column(ForeignKey("restaurants.id", ondelete="CASCADE"), primary_key=True)
    host_choice: Mapped[str] = mapped_column(String(100), nullable=True)
    greeting_text: Mapped[str] = mapped_column(Text, nullable=True)
    info_text: Mapped[str] = mapped_column(Text, nullable=True)


```

```python
from datetime import date
from typing import List, Optional

from pydantic import BaseModel, Field


class TokenResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"


class LoginRequest(BaseModel):
    username: str
    password: str


class BookingCreate(BaseModel):
    restaurant_id: int = Field(..., ge=1)
    date: date
    time_slot: str
    client_name: str


class SlotInfo(BaseModel):
    time: str
    booked: int
    free: int


class SlotsResponse(BaseModel):
    restaurant_id: int
    date: date
    slots: List[SlotInfo]


class RestaurantSettingsIn(BaseModel):
    host_choice: str | None = None
    greeting_text: str | None = None
    info_text: str | None = None


class RestaurantSettingsOut(RestaurantSettingsIn):
    restaurant_id: int


```

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth import get_current_user
from ..db import get_db
from ..models import Restaurant, RestaurantSettings
from ..schemas import RestaurantSettingsIn, RestaurantSettingsOut


router = APIRouter()


@router.get("/{restaurant_id}/settings", response_model=RestaurantSettingsOut)
async def get_settings(restaurant_id: int, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    restaurant = await db.get(Restaurant, restaurant_id)
    if restaurant is None:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

    settings = await db.get(RestaurantSettings, restaurant_id)
    if settings is None:
        # return empty defaults
        return RestaurantSettingsOut(restaurant_id=restaurant_id, host_choice=None, greeting_text=None, info_text=None)
    return RestaurantSettingsOut(
        restaurant_id=restaurant_id,
        host_choice=settings.host_choice,
        greeting_text=settings.greeting_text,
        info_text=settings.info_text,
    )


@router.put("/{restaurant_id}/settings", response_model=RestaurantSettingsOut)
async def update_settings(
    restaurant_id: int,
    payload: RestaurantSettingsIn,
    _: dict = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    restaurant = await db.get(Restaurant, restaurant_id)
    if restaurant is None:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

    settings = await db.get(RestaurantSettings, restaurant_id)
    if settings is None:
        settings = RestaurantSettings(restaurant_id=restaurant_id)
        db.add(settings)

    settings.host_choice = payload.host_choice
    settings.greeting_text = payload.greeting_text
    settings.info_text = payload.info_text

    await db.commit()
    return RestaurantSettingsOut(
        restaurant_id=restaurant_id,
        host_choice=settings.host_choice,
        greeting_text=settings.greeting_text,
        info_text=settings.info_text,
    )


```

```python
from fastapi import APIRouter

from .auth import router as auth_router
from .bookings import router as bookings_router
from .restaurants import router as restaurants_router


api_router = APIRouter()
api_router.include_router(auth_router, prefix="/auth", tags=["auth"])
api_router.include_router(bookings_router, prefix="/bookings", tags=["bookings"])
api_router.include_router(restaurants_router, prefix="/restaurants", tags=["restaurants"])


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (placeholder for OpenAI Assistants integration)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = () => {
    if (!input.trim()) return
    // Placeholder chat: echo response. Later we will wire OpenAI Assistants API here
    setMessages(prev => [...prev, { role: 'user', content: input }, { role: 'assistant', content: '–ü—Ä–∏–Ω—è—Ç–æ. (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ChatGPT –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞)' }])
    setInput('')
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} />
          <button className="btn" onClick={sendMessage}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

```typescriptreact
import { Link, NavLink, Outlet, useNavigate } from 'react-router-dom'
import { useState } from 'react'

export default function Layout() {
  const navigate = useNavigate()
  const [open, setOpen] = useState(false)

  const logout = () => {
    localStorage.removeItem('token')
    navigate('/login')
  }

  const Nav = (
    <>
      <nav className="space-y-2">
        <NavLink to="/bookings" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</NavLink>
        <NavLink to="/settings" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</NavLink>
        <NavLink to="/dashboard" onClick={() => setOpen(false)} className={({isActive}) => `block px-3 py-2 rounded-md ${isActive ? 'bg-gray-100' : 'hover:bg-gray-100'}`}>–î–∞—à–±–æ—Ä–¥</NavLink>
      </nav>
      <button onClick={logout} className="btn mt-8 w-full">–í—ã–π—Ç–∏</button>
    </>
  )

  return (
    <div className="min-h-screen flex">
      {/* Mobile header */}
      <div className="md:hidden fixed top-0 inset-x-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-40">
        <button aria-label="–ú–µ–Ω—é" className="px-3 py-2 rounded-md border hover:bg-gray-50" onClick={() => setOpen(v => !v)}>‚ò∞</button>
        <Link to="/" className="text-lg font-semibold">CRM</Link>
        <div className="w-10" />
      </div>

      {/* Sidebar */}
      <aside className="hidden md:block w-64 bg-white border-r border-gray-200 p-6">
        <div className="mb-8">
          <Link to="/" className="text-xl font-semibold">CRM</Link>
        </div>
        {Nav}
      </aside>

      {/* Mobile drawer */}
      {open && (
        <div className="md:hidden fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/30" onClick={() => setOpen(false)} />
          <div className="absolute left-0 top-0 bottom-0 w-72 bg-white border-r border-gray-200 p-6">
            <div className="mb-6 flex items-center justify-between">
              <Link to="/" className="text-xl font-semibold" onClick={() => setOpen(false)}>CRM</Link>
              <button className="px-2 py-1 rounded-md border hover:bg-gray-50" onClick={() => setOpen(false)}>‚úï</button>
            </div>
            {Nav}
          </div>
        </div>
      )}

      {/* Main */}
      <main className="flex-1 p-4 md:p-8 w-full md:ml-0 pt-16 md:pt-0">
        <Outlet />
      </main>
    </div>
  )
}


```

–°–¥–µ–ª–∞–ª –≤–∫–ª–∞–¥–∫—É ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª –∏ –±–µ–∫–µ–Ω–¥ –ø–æ–¥ –Ω–µ—ë.

–ß—Ç–æ –¥–æ–±–∞–≤–∏–ª
- –ë—ç–∫–µ–Ω–¥:
  - –¢–∞–±–ª–∏—Ü–∞ `restaurant_settings` (–ø–æ–ª—è: `host_choice`, `greeting_text`, `info_text`).
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
    - GET `/restaurants/{restaurant_id}/settings`
    - PUT `/restaurants/{restaurant_id}/settings`
  - –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É, —Ç—Ä–µ–±—É—é—Ç JWT.

- –§—Ä–æ–Ω—Ç–µ–Ω–¥:
  - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –ø—É–Ω–∫—Ç –º–µ–Ω—é –Ω–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.
  - –°—Ç—Ä–∞–Ω–∏—Ü–∞ `–ù–∞—Å—Ç—Ä–æ–π–∫–∏`: –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏
    - –°–ª–µ–≤–∞ —á–∞—Ç (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞; –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º OpenAI Assistants –ø–æ ID).
    - –°–ø—Ä–∞–≤–∞ —Ñ–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:
      - –í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–∑ 5 –∏–º—ë–Ω)
      - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (textarea)
      - –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (textarea)
      - –ö–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å –ë–î —á–µ—Ä–µ–∑ API.
  - –ê–¥–∞–ø—Ç–∏–≤: –Ω–∞ –º–æ–±–∏–ª–µ –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞, –Ω–∞ –±–æ–ª—å—à–∏—Ö ‚Äî –¥–≤–µ.

–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
- –û–±–Ω–æ–≤–∏ `http://localhost:5173` (Cmd+Shift+R).
- –ü–µ—Ä–µ–π–¥–∏ –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª, –∏–∑–º–µ–Ω–∏ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è. –ë–µ–∫–µ–Ω–¥ –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.

–î–∞–ª—å—à–µ: –∫–∞–∫ —Ç–æ–ª—å–∫–æ –¥–∞—à—å ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI, –ø–æ–¥–∫–ª—é—á—É chat –∫ Assistants API –ø—Ä—è–º–æ –≤ –ª–µ–≤–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞.

---

**User**

–í–æ—Ç ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI:
asst_vitxwiKAOhWiFHgynXl07lzT

–í–∞–∂–Ω–æ! –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –Ω–µ –∑–∞–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ Readme

---

**Cursor**

I'll add backend Assistants proxy endpoints, config env vars, wire the frontend chat to use them with your assistant ID, and update README. Then I'll rebuild containers so you can test.

```python
import os
from typing import List


class Settings:
    DB_URL: str = os.getenv("DB_URL", "postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db")
    REDIS_URL: str = os.getenv("REDIS_URL", "redis://redis:6379/0")
    JWT_SECRET: str = os.getenv("JWT_SECRET", "supersecretjwt")
    JWT_ALGORITHM: str = os.getenv("JWT_ALGORITHM", "HS256")
    ADMIN_USERNAME: str = os.getenv("ADMIN_USERNAME", "admin")
    ADMIN_PASSWORD: str = os.getenv("ADMIN_PASSWORD", "password123")
    FRONTEND_ORIGIN: str = os.getenv("FRONTEND_ORIGIN", "http://localhost:5173")
    OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY", "")
    OPENAI_BASE_URL: str = os.getenv("OPENAI_BASE_URL", "https://api.openai.com/v1")

    # Define restaurant-wide default time slots (local time strings HH:MM)
    TIME_SLOTS: List[str] = [
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
        "22:00",
    ]


settings = Settings()


```

```python
from datetime import date
from typing import List, Optional

from pydantic import BaseModel, Field


class TokenResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"


class LoginRequest(BaseModel):
    username: str
    password: str


class BookingCreate(BaseModel):
    restaurant_id: int = Field(..., ge=1)
    date: date
    time_slot: str
    client_name: str


class SlotInfo(BaseModel):
    time: str
    booked: int
    free: int


class SlotsResponse(BaseModel):
    restaurant_id: int
    date: date
    slots: List[SlotInfo]


class RestaurantSettingsIn(BaseModel):
    host_choice: str | None = None
    greeting_text: str | None = None
    info_text: str | None = None


class RestaurantSettingsOut(RestaurantSettingsIn):
    restaurant_id: int


class AssistantChatRequest(BaseModel):
    assistant_id: str
    message: str
    thread_id: str | None = None


class AssistantChatResponse(BaseModel):
    thread_id: str
    assistant_message: str


```

```python
*** Begin Patch
*** Update File: /Users/alexgl/Documents/Projects/Snapyfit/0_AI_hostes_RND/CRM_Proto_v2/backend/app/routers/assistants.py
*** End Patch
```

```python
import asyncio
from typing import Any, Dict, Optional

import httpx
from fastapi import APIRouter, Depends, HTTPException, status

from ..auth import get_current_user
from ..config import settings
from ..schemas import AssistantChatRequest, AssistantChatResponse


router = APIRouter()


async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }


async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    data = resp.json()
    return data["id"]


async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()


async def _create_run(client: httpx.AsyncClient, thread_id: str, assistant_id: str) -> str:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json={"assistant_id": assistant_id},
    )
    resp.raise_for_status()
    return resp.json()["id"]


async def _wait_run_complete(client: httpx.AsyncClient, thread_id: str, run_id: str, timeout_s: float = 30.0) -> None:
    waited = 0.0
    interval = 0.5
    while waited < timeout_s:
        resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
        resp.raise_for_status()
        st = resp.json().get("status")
        if st in ("completed", "failed", "cancelled", "expired"):
            if st != "completed":
                raise HTTPException(status_code=500, detail=f"Assistant run status: {st}")
            return
        await asyncio.sleep(interval)
        waited += interval
    raise HTTPException(status_code=504, detail="Assistant run timeout")


async def _get_last_assistant_message(client: httpx.AsyncClient, thread_id: str) -> str:
    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages", params={"limit": 10, "order": "desc"})
    resp.raise_for_status()
    data = resp.json()
    for msg in data.get("data", []):
        if msg.get("role") == "assistant":
            parts = msg.get("content", [])
            texts = []
            for p in parts:
                if p.get("type") == "text":
                    val = p.get("text", {}).get("value")
                    if val:
                        texts.append(val)
            if texts:
                return "\n\n".join(texts)
    return ""


@router.post("/chat", response_model=AssistantChatResponse)
async def assistant_chat(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()
    async with httpx.AsyncClient(headers=headers, timeout=60) as client:
        thread_id = req.thread_id or await _create_thread(client)
        await _add_message(client, thread_id, req.message)
        run_id = await _create_run(client, thread_id, req.assistant_id)
        await _wait_run_complete(client, thread_id, run_id)
        answer = await _get_last_assistant_message(client, thread_id)
        return AssistantChatResponse(thread_id=thread_id, assistant_message=answer)


```

```python
from fastapi import APIRouter

from .auth import router as auth_router
from .bookings import router as bookings_router
from .restaurants import router as restaurants_router
from .assistants import router as assistants_router


api_router = APIRouter()
api_router.include_router(auth_router, prefix="/auth", tags=["auth"])
api_router.include_router(bookings_router, prefix="/bookings", tags=["bookings"])
api_router.include_router(restaurants_router, prefix="/restaurants", tags=["restaurants"])
api_router.include_router(assistants_router, prefix="/assistants", tags=["assistants"])


```

```dockercompose
version: "3.9"

services:
  db:
    image: postgres:15
    container_name: crm_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-crm_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-crm_password}
      POSTGRES_DB: ${POSTGRES_DB:-crm_db}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: crm_redis
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: crm_backend
    depends_on:
      - db
      - redis
    environment:
      DB_URL: ${DB_URL:-postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      JWT_SECRET: ${JWT_SECRET:-supersecretjwt}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-password123}
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-http://localhost:5173}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports:
      - "8000:8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: crm_frontend
    depends_on:
      - backend
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
      VITE_ASSISTANT_ID: ${VITE_ASSISTANT_ID:-asst_vitxwiKAOhWiFHgynXl07lzT}
    ports:
      - "5173:5173"
    command: npm run dev -- --host 0.0.0.0 --port 5173

volumes:
  db_data:


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = import.meta.env.VITE_ASSISTANT_ID || 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const res = await axios.post(
        `${API_URL}/assistants/chat`,
        { assistant_id: ASSISTANT_ID, message: text, thread_id: threadId },
        authHeaders
      )
      const nextThreadId: string = res.data.thread_id
      const assistantMsg: string = res.data.assistant_message || '(–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)'
      setThreadId(nextThreadId)
      localStorage.setItem('assistant_thread_id', nextThreadId)
      setMessages(prev => [...prev, { role: 'assistant', content: assistantMsg }])
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

```markdown
### Restaurant CRM (v1)

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind), –±—ç–∫–µ–Ω–¥ (FastAPI), PostgreSQL, Redis. –ó–∞–ø—É—Å–∫ –≤ Docker Compose. –ï—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT), –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker-compose up --build
```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:5173`.
4. –í–æ–π–¥–∏—Ç–µ: –ª–æ–≥–∏–Ω `admin`, –ø–∞—Ä–æ–ª—å `password123`.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `frontend/` ‚Äî React + Vite + Tailwind UI
- `backend/` ‚Äî FastAPI + SQLAlchemy + Redis + JWT
- `docker-compose.yml` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

- **Backend**
  - `DB_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db`)
  - `REDIS_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://redis:6379/0`)
  - `JWT_SECRET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `supersecretjwt`)
  - `JWT_ALGORITHM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `HS256`)
  - `ADMIN_USERNAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`)
  - `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `password123`)
  - `FRONTEND_ORIGIN` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:5173`)
  - `OPENAI_API_KEY` (–∫–ª—é—á OpenAI, –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
- **Frontend**
  - `VITE_API_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)
  - `VITE_ASSISTANT_ID` (ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI –¥–ª—è —á–∞—Ç–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–º–æ ID)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:

- `restaurants`
  - `id` (PK)
  - `name`
  - `default_table_count` (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
- `bookings`
  - `id` (PK)
  - `restaurant_id` (FK -> restaurants.id)
  - `date` (date)
  - `time_slot` (string, –Ω–∞–ø—Ä–∏–º–µ—Ä `18:00`)
  - `client_name` (string)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω `id=1` —Å `default_table_count=5`.

### API

–ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
  - `POST /auth/login`
    - –í—Ö–æ–¥: `{ "username": "admin", "password": "password123" }`
    - –û—Ç–≤–µ—Ç: `{ "access_token": "...", "token_type": "bearer" }`
- **–°–ª–æ—Ç—ã –ø–æ –¥–∞—Ç–µ**
  - `GET /bookings/{restaurant_id}/{date}` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –ü—Ä–∏–º–µ—Ä: `/bookings/1/2025-01-01`
  - –û—Ç–≤–µ—Ç: `{ restaurant_id, date, slots: [{ time, booked, free }] }`
  - –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –∫–ª—é—á–æ–º `slots:{restaurant_id}:{date}` –Ω–∞ 1 —á–∞—Å
- **–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
  - `POST /bookings` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –í—Ö–æ–¥: `{ "restaurant_id": 1, "date": "2025-01-01", "time_slot": "18:00", "client_name": "–ò–≤–∞–Ω" }`
  - –û—Ç–≤–µ—Ç: `{ "status": "ok", "booking_id": <id> }`

- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**
  - `GET /restaurants/{restaurant_id}/settings` (JWT)
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`
  - `PUT /restaurants/{restaurant_id}/settings` (JWT)
    - –í—Ö–æ–¥: `{ host_choice: string|null, greeting_text: string|null, info_text: string|null }`
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`

- **–ß–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (OpenAI Assistants v2, –ø—Ä–æ–∫—Å–∏)**
  - `POST /assistants/chat` (JWT)
    - –í—Ö–æ–¥: `{ assistant_id: string, message: string, thread_id?: string }`
    - –û—Ç–≤–µ—Ç: `{ thread_id: string, assistant_message: string }`
    - –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `OPENAI_API_KEY` –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

### –ö—ç—à Redis

- –ö–ª—é—á–∏: `slots:{restaurant_id}:{date}`
- –ó–Ω–∞—á–µ–Ω–∏–µ: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º `{ time: "18:00", booked: 2, free: 3 }`
- TTL: 3600 —Å–µ–∫—É–Ω–¥

### UI

- –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
- –°–∞–π–¥–±–∞—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –î–∞—à–±–æ—Ä–¥
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ —Å –º–æ–¥–∞–ª–∫–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: —Ç–æ–∫–µ–Ω –≤–∫–ª—é—á–∞–µ—Ç `restaurant_id`, —Ç–∞–±–ª–∏—Ü–∞ `restaurants`, —Å–≤—è–∑—å —Å `bookings`.
- –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–∏, –∞ —Ç–∞–∫–∂–µ RBAC –∏ —Ä–µ–∞–ª—å–Ω—ã–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ª–æ–≥–∏–Ω.

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ Docker

- Backend
  ```bash
  cd backend
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  export DB_URL=postgresql+asyncpg://crm_user:crm_password@localhost:5432/crm_db
  export REDIS_URL=redis://localhost:6379/0
  uvicorn app.main:app --reload
  ```
- Frontend
  ```bash
  cd frontend
  npm i
  npm run dev
  ```

### –õ–∏—Ü–µ–Ω–∑–∏—è

MIT


```

- –ü–æ–¥–∫–ª—é—á–∏–ª —á–∞—Ç —Å OpenAI Assistants:
  - –ë—ç–∫–µ–Ω–¥: –¥–æ–±–∞–≤–∏–ª `POST /assistants/chat` (JWT) ‚Äî –ø—Ä–æ–∫—Å–∏ –∫ OpenAI Assistants v2. –¢—Ä–µ–±—É–µ—Ç `OPENAI_API_KEY`.
  - –§—Ä–æ–Ω—Ç–µ–Ω–¥: –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª —á–∞—Ç —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª—å–Ω–æ —à–ª—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–µ–∫, —Ö—Ä–∞–Ω–∏—Ç `thread_id` –≤ localStorage. –ò—Å–ø–æ–ª—å–∑—É—é –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç `VITE_ASSISTANT_ID` (—É–∫–∞–∑–∞–ª –≤–∞—à ID –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç).
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:
  - –ë–î: `restaurant_settings` —Å –ø–æ–ª—è–º–∏ `host_choice`, `greeting_text`, `info_text`.
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: `GET/PUT /restaurants/{restaurant_id}/settings`.
  - UI: —Ñ–æ—Ä–º–∞ —Å–ø—Ä–∞–≤–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ö–æ—Å—Ç–µ—Å (5 –∏–º–µ–Ω), –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –∫–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.
- –û–±–Ω–æ–≤–∏–ª README: –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏ ENV (`OPENAI_API_KEY`, `VITE_ASSISTANT_ID`).

–ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç –≤–∞—Å:
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `OPENAI_API_KEY` –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (—á–µ—Ä–µ–∑ `.env` –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–¥ `docker-compose up`).

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –í–∞—à –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ID: `asst_vitxwiKAOhWiFHgynXl07lzT` —É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `VITE_ASSISTANT_ID`.
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã. –ï—Å–ª–∏ —á–∞—Ç —Å—Ä–∞–∑—É –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–¥–∞–Ω –ª–∏ `OPENAI_API_KEY`.

---

**User**

–º–æ–π –∫–ª—é—á - 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.

–ï–≥–æ —Å—Ä–∞–∑—É –∑–∞—à–µ–π –≤ –ø—Ä–æ–µ–∫—Ç –Ω–∞–≤—Å–µ–≥–¥–∞

---

**Cursor**

–°–æ–∑–¥–∞–º –ª–æ–∫–∞–ª—å–Ω—ã–π .env —Å –∫–ª—é—á–æ–º –∏ ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π), –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—â—É —Å–µ—Ä–≤–∏—Å—ã, —á—Ç–æ–±—ã –±–µ–∫–µ–Ω–¥ –Ω–∞—á–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á.

–Ø –Ω–µ –±—É–¥—É ‚Äú–Ω–∞–≤—Å–µ–≥–¥–∞‚Äù –∑–∞—à–∏–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –≠—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ. –Ø —É–∂–µ:
- –¥–æ–±–∞–≤–∏–ª –∫–ª—é—á –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π .env (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è) –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã;
- —Ñ—Ä–æ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `VITE_ASSISTANT_ID` –∏–∑ .env.

–¢–µ–ø–µ—Ä—å —á–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å. –ï—Å–ª–∏ —É–≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É ‚Äî —Å–∫–∞–∂–∏, –ø—Ä–æ–≤–µ—Ä–∏–º –ª–æ–≥–∏.

---

**User**

–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ OpenAI –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–µ –≤–æ—Ç —Ç–∞–∫–æ–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –æ—à–∏–±–∫–∞—Ö –≤ –∫–æ–Ω—Å–æ–ª–∏:
Failed to load resource: the server responded with a status of 404 (Not Found)Understand this error
settings:1 Access to XMLHttpRequest at 'http://localhost:8000/assistants/chat' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.Understand this error
:8000/assistants/chat:1  Failed to load resource: net::ERR_FAILEDUnderstand this error
settings:1 Access to XMLHttpRequest at 'http://localhost:8000/assistants/chat' from origin 'http://localhost:5173' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.Understand this error
:8000/assistants/chat:1  Failed to load resource: net::ERR_FAILED

---

**Cursor**

–ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—é, —á—Ç–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç /assistants/chat —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–µ –æ—Ç–¥–∞—ë—Ç 404, –∏ —á—Ç–æ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –í—ã–ø–æ–ª–Ω—é –ø—Ä–æ–±–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±—ç–∫–µ–Ω–¥—É –ø—Ä—è–º–æ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞. –ó–∞—Ç–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø–æ–¥–ø—Ä–∞–≤–ª—é –∫–æ–Ω—Ñ–∏–≥ CORS.

–ü–æ—á–∏–Ω–∏–ª –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

–ü—Ä–∏—á–∏–Ω–∞
- –í .env –∫–ª—é—á –±—ã–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Å –ª–∏—à–Ω–µ–π —Ç–æ—á–∫–æ–π –Ω–∞ –∫–æ–Ω—Ü–µ, –∏–∑‚Äë–∑–∞ —á–µ–≥–æ OpenAI –≤–æ–∑–≤—Ä–∞—â–∞–ª 401, –∞ —Ñ—Ä–æ–Ω—Ç –≤–∏–¥–µ–ª 404/CORS.

–ß—Ç–æ —Å–¥–µ–ª–∞–ª
- –û–±–Ω–æ–≤–∏–ª `.env` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `OPENAI_API_KEY` (–±–µ–∑ —Ç–æ—á–∫–∏).
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª –±—ç–∫–µ–Ω–¥. –ü—Ä–æ–≤–µ—Ä–∏–ª: `POST /assistants/chat` —Ç–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–∞–µ—Ç 200, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Ç–µ–±–µ
- –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (Cmd+Shift+R) –∏ –æ—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç. –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è.

---

**User**

–ê –∫–∞–∫ –¥—É–º–∞–µ—à—å, –º–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫–∏–µ-—Ç–æ, —á—Ç–æ–±—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —è –Ω–∞–ø–∏—Å–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞–∏—Ü—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (–∏–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –Ω–µ–µ), —Ç–æ –æ–Ω –±—ã –æ–±–Ω–æ–≤–ª—è–ª –ø–æ–ª–µ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ?

–ù–∞–ø—Ä–∏–º–µ—Ä –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
"–ö–∞–∫–∏–µ —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã —É –≤–∞—Å?"
–Ø –æ—Ç–≤–µ—á–∞—é: "–° 5 –¥–æ 18"

–ò —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ.

–Ø, –ù–∞–ø—Ä–∏–º–µ—Ä, –º–æ–≥—É –ø–æ–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ–±—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –ø–æ–Ω–∏–º–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –≤ –Ω–∞—á–∞–ª–µ –±—É–¥–µ—Ç "INFO_TRIGGER=–∏ –¥–∞–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞–¥–æ –¥–æ–ø–∏—Å–∞—Ç—å –≤ –æ–∫–Ω–æ "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ"

---

**Cursor**

```python
import asyncio
from typing import Any, Dict, Optional

import httpx
from fastapi import APIRouter, Depends, HTTPException, status

from ..auth import get_current_user
from ..config import settings
from ..schemas import AssistantChatRequest, AssistantChatResponse


router = APIRouter()


async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }


async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    data = resp.json()
    return data["id"]


async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()


async def _create_run(
    client: httpx.AsyncClient,
    thread_id: str,
    assistant_id: str,
    instructions: str | None = None,
) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]


async def _wait_run_complete(client: httpx.AsyncClient, thread_id: str, run_id: str, timeout_s: float = 30.0) -> None:
    waited = 0.0
    interval = 0.5
    while waited < timeout_s:
        resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
        resp.raise_for_status()
        st = resp.json().get("status")
        if st in ("completed", "failed", "cancelled", "expired"):
            if st != "completed":
                raise HTTPException(status_code=500, detail=f"Assistant run status: {st}")
            return
        await asyncio.sleep(interval)
        waited += interval
    raise HTTPException(status_code=504, detail="Assistant run timeout")


async def _get_last_assistant_message(client: httpx.AsyncClient, thread_id: str) -> str:
    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages", params={"limit": 10, "order": "desc"})
    resp.raise_for_status()
    data = resp.json()
    for msg in data.get("data", []):
        if msg.get("role") == "assistant":
            parts = msg.get("content", [])
            texts = []
            for p in parts:
                if p.get("type") == "text":
                    val = p.get("text", {}).get("value")
                    if val:
                        texts.append(val)
            if texts:
                return "\n\n".join(texts)
    return ""


@router.post("/chat", response_model=AssistantChatResponse)
async def assistant_chat(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()
    async with httpx.AsyncClient(headers=headers, timeout=60) as client:
        thread_id = req.thread_id or await _create_thread(client)
        await _add_message(client, thread_id, req.message)

        default_instructions = (
            "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ CRM —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, —É—Å–ª–æ–≤–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–ø.), "
            "–¥–æ–±–∞–≤—å –≤ –ù–ê–ß–ê–õ–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞ 'INFO_TRIGGER=' –∏ –¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'. "
            "–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–º–µ—Ä: INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18."
        )
        run_id = await _create_run(client, thread_id, req.assistant_id, instructions=default_instructions)
        await _wait_run_complete(client, thread_id, run_id)
        answer = await _get_last_assistant_message(client, thread_id)
        return AssistantChatResponse(thread_id=thread_id, assistant_message=answer)


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = import.meta.env.VITE_ASSISTANT_ID || 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const res = await axios.post(
        `${API_URL}/assistants/chat`,
        { assistant_id: ASSISTANT_ID, message: text, thread_id: threadId },
        authHeaders
      )
      const nextThreadId: string = res.data.thread_id
      let assistantMsg: string = res.data.assistant_message || '(–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)'
      setThreadId(nextThreadId)
      localStorage.setItem('assistant_thread_id', nextThreadId)

      // Parse INFO_TRIGGER at first line and auto-append to restaurant info
      const lines = assistantMsg.split('\n')
      const firstLine = (lines[0] || '').trim()
      const triggerPrefix = 'INFO_TRIGGER='
      if (firstLine.startsWith(triggerPrefix)) {
        const toAppend = firstLine.slice(triggerPrefix.length).trim()
        if (toAppend) {
          const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
          setInfoText(newInfo)
          try {
            await axios.put(
              `${API_URL}/restaurants/${restaurantId}/settings`,
              { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
              authHeaders
            )
          } catch (e) {
            // ignore save error in chat flow; UI still shows updated state
          }
        }
        // Drop the trigger line from assistant message shown to user
        assistantMsg = lines.slice(1).join('\n').trim()
        if (!assistantMsg) assistantMsg = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
      }

      setMessages(prev => [...prev, { role: 'assistant', content: assistantMsg }])
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–î–∞, —Ç–∞–∫ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. –Ø —É–∂–µ –≤–Ω–µ–¥—Ä–∏–ª –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —ç—Ç–æ–π –ª–æ–≥–∏–∫–∏:

–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å
- –ë—ç–∫–µ–Ω–¥ –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–µ–¥–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
  - –í –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –º–∞—Ä–∫–µ—Ä–æ–º: INFO_TRIGGER=–¢–µ–∫—Å—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ¬ª
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç:
  - –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å INFO_TRIGGER=, —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –ø–æ–ª—é ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ¬ª
  - –≠—Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ API —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –±–µ–∑ —Å—Ç—Ä–æ–∫–∏-—Ç—Ä–∏–≥–≥–µ—Ä–∞

–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
- –í ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç: ¬´–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã —Å 5 –¥–æ 18¬ª.
- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–µ—Ä–Ω—ë—Ç —á—Ç–æ-—Ç–æ –≤–∏–¥–∞:
  - INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18
  - –î–∞–ª–µ–µ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
- –ü–æ–ª–µ ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ¬ª –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —É–ª—É—á—à—É:
- –°–¥–µ–ª–∞—é –∞–∫–∫—É–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–æ–ø–∏—Å—ã–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–æ–∫–∏, –∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º (—á–∞—Å—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω), –∞ –≤ UI –±—É–¥—É —Å–æ–±–∏—Ä–∞—Ç—å —á–∏—Ç–∞–µ–º—ã–π –±–ª–æ–∫.
- –î–æ–±–∞–≤–ª—é —è–≤–Ω—ã–π —á–µ–∫–±–æ–∫—Å-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
- –†–∞—Å—à–∏—Ä—é —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å, —Å—Ç—Ä–æ–≥–∏–π —Ñ–æ—Ä–º–∞—Ç –∏ —Ç.–¥.).

---

**User**

–û–∫–µ–π. –ê —Ç—ã —Ç–æ—á–Ω–æ –¥–µ–ª–∞–µ—à—å –æ–±—â–µ–Ω–∏–µ –ø–æ API —Å Assistant API? –ü–æ—Ç–æ–º—É —á—Ç–æ —Å–µ–π—á–∞—Å –±—É–¥—Ç–æ —è –æ–±—â–∞—é—Å—å —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —á–∞—Ç–æ–º –∫–∞–∫–∏–º-—Ç–æ?

–¢–∞–º –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–∞–∫–æ–µ –µ—Å—Ç—å:
To use this API version pass a beta HTTP Header:
OpenAI-Beta: assistants=v2
Not required with official Node and Python SDKs.

@https://platform.openai.com/docs/assistants/quickstart#page-top 

---

**Cursor**

–î–∞, –æ–±—â–µ–Ω–∏–µ –∏–¥—ë—Ç –∏–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ Assistants API v2: –º—ã —Å–æ–∑–¥–∞—ë–º thread, –¥–æ–±–∞–≤–ª—è–µ–º message –∏ –∑–∞–ø—É—Å–∫–∞–µ–º run, –ø–µ—Ä–µ–¥–∞–≤–∞—è beta‚Äë–∑–∞–≥–æ–ª–æ–≤–æ–∫ OpenAI‚ÄëBeta: assistants=v2.

–°–º. –∫–ª—é—á–µ–≤—ã–µ –º–µ—Å—Ç–∞ –∫–æ–¥–∞:

```65:86:backend/app/routers/assistants.py
async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }

async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    return resp.json()["id"]

async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()

async def _create_run(client: httpx.AsyncClient, thread_id: str, assistant_id: str, instructions: str | None = None) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]
```

–¢–∞–∫–∂–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ run —è –¥–æ–±–∞–≤–ª—è—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º INFO_TRIGGER, —á—Ç–æ–±—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–ª –º–∞—Ä–∫–µ—Ä –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç—ã –∫–∞–∂—É—Ç—Å—è ‚Äú–¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏‚Äù, —ç—Ç–æ –æ–±—ã—á–Ω–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, –∫–∞–∫–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–¥–∞–Ω—ã —É —Å–∞–º–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ OpenAI. –ú–æ–≥—É —É—Å–∏–ª–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –Ω–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–Ω–µ—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–æ–º–ø—Ç –ø–æ–¥ –≤–∞—à —Å—Ç–∏–ª—å). –•–æ—Ç–∏—Ç–µ ‚Äî –¥–æ–±–∞–≤–ª—é –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `ASSISTANT_INSTRUCTIONS` –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é –≤ README.

```python
async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }

async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    return resp.json()["id"]

async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()

async def _create_run(client: httpx.AsyncClient, thread_id: str, assistant_id: str, instructions: str | None = None) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]
```

---

**User**

–•–æ—á—É –µ—â–µ —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–∏—Å–∞–ª–æ—Å—å —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º –≤ –º–æ–π —á–∞—Ç

---

**Cursor**

I'll implement a streaming chat endpoint on the backend using FastAPI's StreamingResponse and a polling approach, then update the frontend to consume the stream via fetch and append deltas to the chat. I'll also update the README with the new endpoint. Now making the code changes and rebuilding services.

```python
import asyncio
from typing import Any, Dict, Optional

import httpx
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import StreamingResponse

from ..auth import get_current_user
from ..config import settings
from ..schemas import AssistantChatRequest, AssistantChatResponse


router = APIRouter()


async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }


async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    data = resp.json()
    return data["id"]


async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()


async def _create_run(
    client: httpx.AsyncClient,
    thread_id: str,
    assistant_id: str,
    instructions: str | None = None,
) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]


async def _wait_run_complete(client: httpx.AsyncClient, thread_id: str, run_id: str, timeout_s: float = 30.0) -> None:
    waited = 0.0
    interval = 0.5
    while waited < timeout_s:
        resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
        resp.raise_for_status()
        st = resp.json().get("status")
        if st in ("completed", "failed", "cancelled", "expired"):
            if st != "completed":
                raise HTTPException(status_code=500, detail=f"Assistant run status: {st}")
            return
        await asyncio.sleep(interval)
        waited += interval
    raise HTTPException(status_code=504, detail="Assistant run timeout")


async def _get_last_assistant_message(client: httpx.AsyncClient, thread_id: str) -> str:
    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages", params={"limit": 10, "order": "desc"})
    resp.raise_for_status()
    data = resp.json()
    for msg in data.get("data", []):
        if msg.get("role") == "assistant":
            parts = msg.get("content", [])
            texts = []
            for p in parts:
                if p.get("type") == "text":
                    val = p.get("text", {}).get("value")
                    if val:
                        texts.append(val)
            if texts:
                return "\n\n".join(texts)
    return ""


@router.post("/chat", response_model=AssistantChatResponse)
async def assistant_chat(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()
    async with httpx.AsyncClient(headers=headers, timeout=60) as client:
        thread_id = req.thread_id or await _create_thread(client)
        await _add_message(client, thread_id, req.message)

        default_instructions = (
            "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ CRM —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, —É—Å–ª–æ–≤–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–ø.), "
            "–¥–æ–±–∞–≤—å –≤ –ù–ê–ß–ê–õ–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞ 'INFO_TRIGGER=' –∏ –¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'. "
            "–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–º–µ—Ä: INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18."
        )
        run_id = await _create_run(client, thread_id, req.assistant_id, instructions=default_instructions)
        await _wait_run_complete(client, thread_id, run_id)
        answer = await _get_last_assistant_message(client, thread_id)
        return AssistantChatResponse(thread_id=thread_id, assistant_message=answer)


@router.post("/chat_stream")
async def assistant_chat_stream(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()

    async def event_generator():
        async with httpx.AsyncClient(headers=headers, timeout=60) as client:
            thread_id = req.thread_id or await _create_thread(client)
            yield f"data: { { 'thread_id': thread_id } }\n\n"
            await _add_message(client, thread_id, req.message)

            default_instructions = (
                "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ CRM —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, —É—Å–ª–æ–≤–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–ø.), "
                "–¥–æ–±–∞–≤—å –≤ –ù–ê–ß–ê–õ–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞ 'INFO_TRIGGER=' –∏ –¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'. "
                "–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–º–µ—Ä: INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18."
            )
            run_id = await _create_run(client, thread_id, req.assistant_id, instructions=default_instructions)

            accumulated = ""
            try:
                while True:
                    # Check run state
                    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
                    resp.raise_for_status()
                    st = resp.json().get("status")

                    # Read latest assistant text
                    msg_resp = await client.get(
                        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
                        params={"limit": 1, "order": "desc"},
                    )
                    msg_resp.raise_for_status()
                    data = msg_resp.json()
                    latest_text = ""
                    if data.get("data"):
                        msg = data["data"][0]
                        if msg.get("role") == "assistant":
                            parts = msg.get("content", [])
                            chunks = []
                            for p in parts:
                                if p.get("type") == "text":
                                    val = p.get("text", {}).get("value")
                                    if val:
                                        chunks.append(val)
                            latest_text = "\n\n".join(chunks)

                    if len(latest_text) > len(accumulated):
                        delta = latest_text[len(accumulated):]
                        accumulated = latest_text
                        # send delta
                        yield f"data: {{\"delta\": {json.dumps(delta)} }}\n\n"

                    if st in ("completed", "failed", "cancelled", "expired"):
                        if st != "completed":
                            yield f"data: {{\"error\": \"{st}\"}}\n\n"
                        break
                    await asyncio.sleep(0.5)
            finally:
                # final event
                yield f"data: {{\"done\": true, \"thread_id\": \"{thread_id}\"}}\n\n"

    return StreamingResponse(event_generator(), media_type="text/event-stream")


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = import.meta.env.VITE_ASSISTANT_ID || 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const firstLine = (lines[0] || '').trim()
        const triggerPrefix = 'INFO_TRIGGER='
        if (firstLine.startsWith(triggerPrefix)) {
          const toAppend = firstLine.slice(triggerPrefix.length).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          assistantAccum = lines.slice(1).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = eval('(' + jsonStr + ')') // { delta?, error?, done?, thread_id? }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

```markdown
### Restaurant CRM (v1)

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind), –±—ç–∫–µ–Ω–¥ (FastAPI), PostgreSQL, Redis. –ó–∞–ø—É—Å–∫ –≤ Docker Compose. –ï—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT), –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker-compose up --build
```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:5173`.
4. –í–æ–π–¥–∏—Ç–µ: –ª–æ–≥–∏–Ω `admin`, –ø–∞—Ä–æ–ª—å `password123`.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `frontend/` ‚Äî React + Vite + Tailwind UI
- `backend/` ‚Äî FastAPI + SQLAlchemy + Redis + JWT
- `docker-compose.yml` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

- **Backend**
  - `DB_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db`)
  - `REDIS_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://redis:6379/0`)
  - `JWT_SECRET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `supersecretjwt`)
  - `JWT_ALGORITHM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `HS256`)
  - `ADMIN_USERNAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`)
  - `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `password123`)
  - `FRONTEND_ORIGIN` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:5173`)
  - `OPENAI_API_KEY` (–∫–ª—é—á OpenAI, –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
- **Frontend**
  - `VITE_API_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)
  - `VITE_ASSISTANT_ID` (ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI –¥–ª—è —á–∞—Ç–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–º–æ ID)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:

- `restaurants`
  - `id` (PK)
  - `name`
  - `default_table_count` (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
- `bookings`
  - `id` (PK)
  - `restaurant_id` (FK -> restaurants.id)
  - `date` (date)
  - `time_slot` (string, –Ω–∞–ø—Ä–∏–º–µ—Ä `18:00`)
  - `client_name` (string)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω `id=1` —Å `default_table_count=5`.

### API

–ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
  - `POST /auth/login`
    - –í—Ö–æ–¥: `{ "username": "admin", "password": "password123" }`
    - –û—Ç–≤–µ—Ç: `{ "access_token": "...", "token_type": "bearer" }`
- **–°–ª–æ—Ç—ã –ø–æ –¥–∞—Ç–µ**
  - `GET /bookings/{restaurant_id}/{date}` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –ü—Ä–∏–º–µ—Ä: `/bookings/1/2025-01-01`
  - –û—Ç–≤–µ—Ç: `{ restaurant_id, date, slots: [{ time, booked, free }] }`
  - –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –∫–ª—é—á–æ–º `slots:{restaurant_id}:{date}` –Ω–∞ 1 —á–∞—Å
- **–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
  - `POST /bookings` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –í—Ö–æ–¥: `{ "restaurant_id": 1, "date": "2025-01-01", "time_slot": "18:00", "client_name": "–ò–≤–∞–Ω" }`
  - –û—Ç–≤–µ—Ç: `{ "status": "ok", "booking_id": <id> }`

- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**
  - `GET /restaurants/{restaurant_id}/settings` (JWT)
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`
  - `PUT /restaurants/{restaurant_id}/settings` (JWT)
    - –í—Ö–æ–¥: `{ host_choice: string|null, greeting_text: string|null, info_text: string|null }`
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`

- **–ß–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (OpenAI Assistants v2, –ø—Ä–æ–∫—Å–∏)**
  - `POST /assistants/chat` (JWT)
    - –í—Ö–æ–¥: `{ assistant_id: string, message: string, thread_id?: string }`
    - –û—Ç–≤–µ—Ç: `{ thread_id: string, assistant_message: string }`
    - –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `OPENAI_API_KEY` –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
  - `POST /assistants/chat_stream` (JWT, Server-Sent Events)
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–æ–∫ `text/event-stream` —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –≤–∏–¥–∞ `data: { "delta": "..." }` –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º `data: { "done": true, "thread_id": "..." }`
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.

### –ö—ç—à Redis

- –ö–ª—é—á–∏: `slots:{restaurant_id}:{date}`
- –ó–Ω–∞—á–µ–Ω–∏–µ: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º `{ time: "18:00", booked: 2, free: 3 }`
- TTL: 3600 —Å–µ–∫—É–Ω–¥

### UI

- –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
- –°–∞–π–¥–±–∞—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –î–∞—à–±–æ—Ä–¥
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ —Å –º–æ–¥–∞–ª–∫–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: —Ç–æ–∫–µ–Ω –≤–∫–ª—é—á–∞–µ—Ç `restaurant_id`, —Ç–∞–±–ª–∏—Ü–∞ `restaurants`, —Å–≤—è–∑—å —Å `bookings`.
- –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–∏, –∞ —Ç–∞–∫–∂–µ RBAC –∏ —Ä–µ–∞–ª—å–Ω—ã–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ª–æ–≥–∏–Ω.

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ Docker

- Backend
  ```bash
  cd backend
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  export DB_URL=postgresql+asyncpg://crm_user:crm_password@localhost:5432/crm_db
  export REDIS_URL=redis://localhost:6379/0
  uvicorn app.main:app --reload
  ```
- Frontend
  ```bash
  cd frontend
  npm i
  npm run dev
  ```

### –õ–∏—Ü–µ–Ω–∑–∏—è

MIT


```

–°–¥–µ–ª–∞–ª —Å—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —á–∞—Ç.

–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- –ë—ç–∫–µ–Ω–¥:
  - –ù–æ–≤—ã–π SSE-—ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /assistants/chat_stream` (JWT). –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `text/event-stream` —Å —Å–æ–±—ã—Ç–∏—è–º–∏:
    - data: {"thread_id": "..."} ‚Äî —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–µ–¥–∞
    - data: {"delta": "..."} ‚Äî –ø—Ä–∏—Ä–∞—â–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    - data: {"done": true, "thread_id": "..."} ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
  - –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Assistants API v2 c –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `OpenAI-Beta: assistants=v2` –∏ —Ç–µ–º–∏ –∂–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è INFO_TRIGGER.
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–≤–∫–ª–∞–¥–∫–∞ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª):
  - –ß–∞—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fetch(.../assistants/chat_stream)` –∏ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ –¥–æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
  - –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ç—Ä–∏–º–∞ –ø–∞—Ä—Å–∏—Ç INFO_TRIGGER –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ¬ª.

–ü—Ä–æ–≤–µ—Ä—å:
- –í ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª –æ—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —Ç–µ–∫—Å—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–ª—è—Ç—å—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ.
- –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–¥—ë—Ç `INFO_TRIGGER=...`, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ `README.md` (–æ–ø–∏—Å–∞–Ω `POST /assistants/chat_stream`).

---

**User**

Settings.tsx:68  POST http://localhost:8000/assistants/chat_stream net::ERR_INCOMPLETE_CHUNKED_ENCODING 200 (OK)

---

**Cursor**

```python
import asyncio
import json
from typing import Any, Dict, Optional

import httpx
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import StreamingResponse

from ..auth import get_current_user
from ..config import settings
from ..schemas import AssistantChatRequest, AssistantChatResponse


router = APIRouter()


async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }


async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    data = resp.json()
    return data["id"]


async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()


async def _create_run(
    client: httpx.AsyncClient,
    thread_id: str,
    assistant_id: str,
    instructions: str | None = None,
) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]


async def _wait_run_complete(client: httpx.AsyncClient, thread_id: str, run_id: str, timeout_s: float = 30.0) -> None:
    waited = 0.0
    interval = 0.5
    while waited < timeout_s:
        resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
        resp.raise_for_status()
        st = resp.json().get("status")
        if st in ("completed", "failed", "cancelled", "expired"):
            if st != "completed":
                raise HTTPException(status_code=500, detail=f"Assistant run status: {st}")
            return
        await asyncio.sleep(interval)
        waited += interval
    raise HTTPException(status_code=504, detail="Assistant run timeout")


async def _get_last_assistant_message(client: httpx.AsyncClient, thread_id: str) -> str:
    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages", params={"limit": 10, "order": "desc"})
    resp.raise_for_status()
    data = resp.json()
    for msg in data.get("data", []):
        if msg.get("role") == "assistant":
            parts = msg.get("content", [])
            texts = []
            for p in parts:
                if p.get("type") == "text":
                    val = p.get("text", {}).get("value")
                    if val:
                        texts.append(val)
            if texts:
                return "\n\n".join(texts)
    return ""


@router.post("/chat", response_model=AssistantChatResponse)
async def assistant_chat(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()
    async with httpx.AsyncClient(headers=headers, timeout=60) as client:
        thread_id = req.thread_id or await _create_thread(client)
        await _add_message(client, thread_id, req.message)

        default_instructions = (
            "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ CRM —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, —É—Å–ª–æ–≤–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–ø.), "
            "–¥–æ–±–∞–≤—å –≤ –ù–ê–ß–ê–õ–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞ 'INFO_TRIGGER=' –∏ –¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'. "
            "–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–º–µ—Ä: INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18."
        )
        run_id = await _create_run(client, thread_id, req.assistant_id, instructions=default_instructions)
        await _wait_run_complete(client, thread_id, run_id)
        answer = await _get_last_assistant_message(client, thread_id)
        return AssistantChatResponse(thread_id=thread_id, assistant_message=answer)


@router.post("/chat_stream")
async def assistant_chat_stream(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()

    async def event_generator():
        async with httpx.AsyncClient(headers=headers, timeout=60) as client:
            try:
                thread_id = req.thread_id or await _create_thread(client)
                yield f"data: {json.dumps({ 'thread_id': thread_id })}\n\n"
                await _add_message(client, thread_id, req.message)

                default_instructions = (
                    "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ CRM —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ (—á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω, —É—Å–ª–æ–≤–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ç.–ø.), "
                    "–¥–æ–±–∞–≤—å –≤ –ù–ê–ß–ê–õ–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∞ 'INFO_TRIGGER=' –∏ –¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ '–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'. "
                    "–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–º–µ—Ä: INFO_TRIGGER=–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: —Å 5 –¥–æ 18."
                )
                run_id = await _create_run(client, thread_id, req.assistant_id, instructions=default_instructions)

                accumulated = ""
                while True:
                    # Check run state
                    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
                    resp.raise_for_status()
                    st = resp.json().get("status")

                    # Read latest assistant text
                    msg_resp = await client.get(
                        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
                        params={"limit": 1, "order": "desc"},
                    )
                    msg_resp.raise_for_status()
                    data = msg_resp.json()
                    latest_text = ""
                    if data.get("data"):
                        msg = data["data"][0]
                        if msg.get("role") == "assistant":
                            parts = msg.get("content", [])
                            chunks = []
                            for p in parts:
                                if p.get("type") == "text":
                                    val = p.get("text", {}).get("value")
                                    if val:
                                        chunks.append(val)
                            latest_text = "\n\n".join(chunks)

                    if len(latest_text) > len(accumulated):
                        delta = latest_text[len(accumulated):]
                        accumulated = latest_text
                        # send delta
                        yield f"data: {json.dumps({ 'delta': delta })}\n\n"

                    if st in ("completed", "failed", "cancelled", "expired"):
                        if st != "completed":
                            yield f"data: {json.dumps({ 'error': st })}\n\n"
                        break
                    await asyncio.sleep(0.5)
            except Exception as e:
                yield f"data: {json.dumps({ 'error': str(e) })}\n\n"
            finally:
                # final event
                try:
                    # thread_id may not exist if error before creation
                    tid = locals().get('thread_id', None)
                    payload = { 'done': True }
                    if tid:
                        payload['thread_id'] = tid
                    yield f"data: {json.dumps(payload)}\n\n"
                except Exception:
                    pass

    return StreamingResponse(event_generator(), media_type="text/event-stream", headers={
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
    })


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = import.meta.env.VITE_ASSISTANT_ID || 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const firstLine = (lines[0] || '').trim()
        const triggerPrefix = 'INFO_TRIGGER='
        if (firstLine.startsWith(triggerPrefix)) {
          const toAppend = firstLine.slice(triggerPrefix.length).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          assistantAccum = lines.slice(1).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = JSON.parse(jsonStr) as { delta?: string; error?: string; done?: boolean; thread_id?: string }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–ò—Å–ø—Ä–∞–≤–∏–ª —Å—Ç—Ä–∏–º–∏–Ω–≥:
- –ù–∞ –±—ç–∫–µ–Ω–¥–µ: –æ—Ç–¥–∞—ë–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SSE —Å JSON —á–µ—Ä–µ–∑ StreamingResponse, –¥–æ–±–∞–≤–∏–ª –∑–∞–≥–æ–ª–æ–≤–∫–∏ Connection/Cache-Control, –∑–∞–º–µ–Ω–∏–ª —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã–π JSON –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–ª —Ñ–∏–Ω–∞–ª—å–Ω—ã–π done-—Å–æ–±—ã—Ç–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.
- –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ: –ø–∞—Ä—Å–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ JSON.parse (—É–±—Ä–∞–ª eval), –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –±—É—Ñ–µ—Ä–∏–∑—É—é –ø–æ –¥–≤–æ–π–Ω–æ–º—É –ø–µ—Ä–µ–Ω–æ—Å—É —Å—Ç—Ä–æ–∫–∏.

–ü—Ä–æ–≤–µ—Ä—å –µ—â—ë —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª. –û—à–∏–±–∫–∞ net::ERR_INCOMPLETE_CHUNKED_ENCODING –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å, –∞ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –ø–ª–∞–≤–Ω–æ –¥–æ–ø–∏—Å—ã–≤–∞—Ç—å—Å—è.

---

**User**

–ú–æ–∂–µ—à—å –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∫–æ–¥?
asst_vitxwiKAOhWiFHgynXl07lzT

---

**Cursor**

I'll hardcode the assistant ID in the frontend code and rebuild the frontend container so it takes effect.

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const firstLine = (lines[0] || '').trim()
        const triggerPrefix = 'INFO_TRIGGER='
        if (firstLine.startsWith(triggerPrefix)) {
          const toAppend = firstLine.slice(triggerPrefix.length).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          assistantAccum = lines.slice(1).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = JSON.parse(jsonStr) as { delta?: string; error?: string; done?: boolean; thread_id?: string }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–ì–æ—Ç–æ–≤–æ. –ó–∞—à–∏–ª ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Ñ—Ä–æ–Ω—Ç: `asst_vitxwiKAOhWiFHgynXl07lzT`. –ü–µ—Ä–µ—Å–æ–±—Ä–∞–ª –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª (Cmd+Shift+R), —á–∞—Ç –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç ID.

---

**User**

–Ø –ø–æ–Ω—è–ª –≤ —á–µ–º –¥–µ–ª–æ. –£ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–µ—Ñ–æ–ª—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Ç—ã –ø–∏—à–µ—à—å —Å–∞–º - –∞ –º–Ω–µ –Ω–∞–¥–æ —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ —Ç–∞–∫–æ–π, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ OpenAI –ù–∞–ø–∏—Å–∞–Ω–∞. –£–¥–∞–ª–∏ –µ–µ –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞

---

**Cursor**

```python
import asyncio
import json
from typing import Any, Dict, Optional

import httpx
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import StreamingResponse

from ..auth import get_current_user
from ..config import settings
from ..schemas import AssistantChatRequest, AssistantChatResponse


router = APIRouter()


async def _assistants_headers() -> Dict[str, str]:
    if not settings.OPENAI_API_KEY:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="OPENAI_API_KEY not configured")
    return {
        "Authorization": f"Bearer {settings.OPENAI_API_KEY}",
        "Content-Type": "application/json",
        "OpenAI-Beta": "assistants=v2",
    }


async def _create_thread(client: httpx.AsyncClient) -> str:
    resp = await client.post(f"{settings.OPENAI_BASE_URL}/threads", json={})
    resp.raise_for_status()
    data = resp.json()
    return data["id"]


async def _add_message(client: httpx.AsyncClient, thread_id: str, content: str) -> None:
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
        json={"role": "user", "content": content},
    )
    resp.raise_for_status()


async def _create_run(
    client: httpx.AsyncClient,
    thread_id: str,
    assistant_id: str,
    instructions: str | None = None,
) -> str:
    body: Dict[str, Any] = {"assistant_id": assistant_id}
    if instructions:
        body["instructions"] = instructions
    resp = await client.post(
        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs",
        json=body,
    )
    resp.raise_for_status()
    return resp.json()["id"]


async def _wait_run_complete(client: httpx.AsyncClient, thread_id: str, run_id: str, timeout_s: float = 30.0) -> None:
    waited = 0.0
    interval = 0.5
    while waited < timeout_s:
        resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
        resp.raise_for_status()
        st = resp.json().get("status")
        if st in ("completed", "failed", "cancelled", "expired"):
            if st != "completed":
                raise HTTPException(status_code=500, detail=f"Assistant run status: {st}")
            return
        await asyncio.sleep(interval)
        waited += interval
    raise HTTPException(status_code=504, detail="Assistant run timeout")


async def _get_last_assistant_message(client: httpx.AsyncClient, thread_id: str) -> str:
    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages", params={"limit": 10, "order": "desc"})
    resp.raise_for_status()
    data = resp.json()
    for msg in data.get("data", []):
        if msg.get("role") == "assistant":
            parts = msg.get("content", [])
            texts = []
            for p in parts:
                if p.get("type") == "text":
                    val = p.get("text", {}).get("value")
                    if val:
                        texts.append(val)
            if texts:
                return "\n\n".join(texts)
    return ""


@router.post("/chat", response_model=AssistantChatResponse)
async def assistant_chat(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()
    async with httpx.AsyncClient(headers=headers, timeout=60) as client:
        thread_id = req.thread_id or await _create_thread(client)
        await _add_message(client, thread_id, req.message)
        run_id = await _create_run(client, thread_id, req.assistant_id)
        await _wait_run_complete(client, thread_id, run_id)
        answer = await _get_last_assistant_message(client, thread_id)
        return AssistantChatResponse(thread_id=thread_id, assistant_message=answer)


@router.post("/chat_stream")
async def assistant_chat_stream(req: AssistantChatRequest, _: dict = Depends(get_current_user)):
    headers = await _assistants_headers()

    async def event_generator():
        async with httpx.AsyncClient(headers=headers, timeout=60) as client:
            try:
                thread_id = req.thread_id or await _create_thread(client)
                yield f"data: {json.dumps({ 'thread_id': thread_id })}\n\n"
                await _add_message(client, thread_id, req.message)
                run_id = await _create_run(client, thread_id, req.assistant_id)

                accumulated = ""
                while True:
                    # Check run state
                    resp = await client.get(f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/runs/{run_id}")
                    resp.raise_for_status()
                    st = resp.json().get("status")

                    # Read latest assistant text
                    msg_resp = await client.get(
                        f"{settings.OPENAI_BASE_URL}/threads/{thread_id}/messages",
                        params={"limit": 1, "order": "desc"},
                    )
                    msg_resp.raise_for_status()
                    data = msg_resp.json()
                    latest_text = ""
                    if data.get("data"):
                        msg = data["data"][0]
                        if msg.get("role") == "assistant":
                            parts = msg.get("content", [])
                            chunks = []
                            for p in parts:
                                if p.get("type") == "text":
                                    val = p.get("text", {}).get("value")
                                    if val:
                                        chunks.append(val)
                            latest_text = "\n\n".join(chunks)

                    if len(latest_text) > len(accumulated):
                        delta = latest_text[len(accumulated):]
                        accumulated = latest_text
                        # send delta
                        yield f"data: {json.dumps({ 'delta': delta })}\n\n"

                    if st in ("completed", "failed", "cancelled", "expired"):
                        if st != "completed":
                            yield f"data: {json.dumps({ 'error': st })}\n\n"
                        break
                    await asyncio.sleep(0.5)
            except Exception as e:
                yield f"data: {json.dumps({ 'error': str(e) })}\n\n"
            finally:
                # final event
                try:
                    # thread_id may not exist if error before creation
                    tid = locals().get('thread_id', None)
                    payload = { 'done': True }
                    if tid:
                        payload['thread_id'] = tid
                    yield f"data: {json.dumps(payload)}\n\n"
                except Exception:
                    pass

    return StreamingResponse(event_generator(), media_type="text/event-stream", headers={
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
    })


```

–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É–±—Ä–∞–ª –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞. –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ run –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∑–∞–¥–∞–Ω–æ —É –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ OpenAI.

- –û–±–Ω–æ–≤–∏–ª –æ–±–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞: –∏ –æ–±—ã—á–Ω—ã–π `/assistants/chat`, –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã–π `/assistants/chat_stream` ‚Äî –±–æ–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç —Å–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- –ë—ç–∫–µ–Ω–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –ú–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä—è—Ç—å: –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—É, –∑–∞–¥–∞–Ω–Ω–æ–º—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ OpenAI.

---

**User**

–°—É–ø–µ—Ä!
–°–µ–π—á–∞—Å —É –º–µ–Ω—è —Ç–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É –Ω–µ–≥–æ:
–¢—ã —Å–æ–±–∏—Ä–∞–µ—à—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –æ –µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ —É–∑–Ω–∞—Ç—å:
1) –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
2) –ß—Ç–æ —Å–∞–º–æ–µ –∫—Ä—É—Ç–æ–µ –µ—Å—Ç—å –≤ –º–µ–Ω—é
3) –ï—Å—Ç—å –ª–∏ –ø–∞—Ä–∫–æ–≤–∫–∞ –∏ –Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç
4) –ü–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è

–ö–æ–≥–¥–∞ –æ–±—â–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è - —Å—Ä–∞–∑—É –∂–µ –Ω–∞—á–∏–Ω–∞–π –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ - —Å—Ç–∞—Ä–∞–π—Å—è –Ω–µ –¥–∞–≤–∞—Ç—å —É–≤–æ–¥–∏—Ç—å –±–µ—Å–µ–¥—É –≤ —Å—Ç–æ—Ä–æ–Ω—É

–í–µ–¥–∏ –æ–±—â–µ–Ω–∏–µ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ–± —ç—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–Ω —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —á—Ç–æ–±—ã –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –æ–Ω –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å - –ø–∏—à–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å + –Ω–∞–ø–∏—à–∏ INFO_TRIGGER=–∏ —Ç—É—Ç –Ω–∞–ø–∏—à–∏ —Ç–æ, —á—Ç–æ –ø–æ–Ω—è–ª –∏–∑ –µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ. –≠—Ç–æ –±—É–¥–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –º–æ–µ–π —Å–∏—Å—Ç–µ–º–µ. –ù–∞—Ä–ø–∏–º–µ—Ä:

–¢—ã –ø–∏—à–µ—à—å "–ö–∞–∫–∏–µ —É –≤–∞—Å —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã?"
–û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç "–° 15 –¥–æ 21"
–¢—ã –¥–∞–ª—å—à–µ –ø–∏—à–µ—à—å "–û—Ç–ª–∏—á–Ω–æ, –∞ —Å —Å–µ–º—å–µ–π –º–æ–∂–Ω–æ –∫ –≤–∞–º?
INFO_TRIGGER=–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å 15.00 –¥–æ 21.00"




–ò —Å–µ–π—á–∞—Å –∫–æ–≥–¥–∞ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–Ω–µ:
"–û—Ç–ª–∏—á–Ω–æ! –ê —É –≤–∞—Å –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ –≤ –º–µ–Ω—é, —á—Ç–æ —Å—Ç–æ–∏—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?  
INFO_TRIGGER=–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å 15.00 –¥–æ 20.00"
–ò —É –º–µ–Ω—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –≤ –±–ª–æ–∫–µ "–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" —ç—Ç–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª–æ—Å—å –∏ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å —Å–µ–π—á–∞—Å

---

**Cursor**

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const triggerIndex = lines.findIndex(l => l.trim().toUpperCase().startsWith('INFO_TRIGGER='))
        if (triggerIndex >= 0) {
          const raw = lines[triggerIndex].trim()
          const toAppend = raw.slice(raw.indexOf('=') + 1).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          // Remove trigger line from assistant visible text
          assistantAccum = lines.filter((_, i) => i !== triggerIndex).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = JSON.parse(jsonStr) as { delta?: string; error?: string; done?: boolean; thread_id?: string }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–û–±–Ω–æ–≤–∏–ª –ø–∞—Ä—Å–∏–Ω–≥ INFO_TRIGGER –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ:
- –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ), –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞.
- –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ¬ª, —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ API, –∏ —É–¥–∞–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —á–∞—Ç–µ.

–¢–µ–ø–µ—Ä—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∞:
"–û—Ç–ª–∏—á–Ω–æ! ...  
INFO_TRIGGER=–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —Å 15.00 –¥–æ 20.00"
–±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–ª–æ–∫ ¬´–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è¬ª.

---

**User**

–û–∫–µ–π –∑–¥–µ—Å—å –∑–∞–∫–æ–Ω—á–∏–ª–∏. –í–µ—Ä–Ω–µ–º—Å—è –≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –≤ –º–µ–Ω—é, –∫–æ–≥–¥–∞ –º—ã –Ω–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è". –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–∫–∏–µ –ø–æ–ª—è (–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–∫–∂–µ, –∏ –ø—Ä–∏ API –ó–∞–ø—Ä–æ—Å–∞—Ö –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ —Ç–æ–∂–µ —Ç–∞–∫–∏–µ –∂–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã):

–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞: –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏
–ü–æ–ª—è –≤–Ω—É—Ç—Ä–∏:
	1.	–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω —Å –≤—ã–±–æ—Ä–æ–º –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞)
	2.	–¢–µ–ª–µ—Ñ–æ–Ω (–ø—Ä–∏–º–µ—Ä: +7 (915) 123-45-67)
	3.	–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è* (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤)
	6.	–ü–µ—Ä—Å–æ–Ω ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π (–ø—Ä–∏–º–µ—Ä: 4)
	10.	–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
	11.	–¢–µ–≥–∏ ‚Äî –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç (–ø—Ä–∏–º–µ—Ä: ¬´–ü–∞—Ä–∫–æ–≤–∫–∞¬ª)
	13.	–î–µ–ø–æ–∑–∏—Ç ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å:
	‚Ä¢	¬´–° –¥–µ–ø–æ–∑–∏—Ç–æ–º¬ª
	‚Ä¢	¬´–ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞¬ª (–≤—ã–±—Ä–∞–Ω–æ)

---

**Cursor**

–°–µ–π—á–∞—Å –æ–±–Ω–æ–≤–ª—é backend –º–æ–¥–µ–ª—å –∏ —Å—Ö–µ–º—É, –¥–æ–±–∞–≤–ª—é —Å—Ç–æ–ª–±—Ü—ã —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ ALTER TABLE –Ω–∞ —Å—Ç–∞—Ä—Ç–µ, –æ–±–Ω–æ–≤–ª—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏, –∑–∞—Ç–µ–º –∏–∑–º–µ–Ω—é —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–¥–∞–ª–∫—É —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏. –ü–µ—Ä–µ—Å–æ–±–µ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ–±–Ω–æ–≤–ª—é README —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ API.

```python
from sqlalchemy import ForeignKey, Integer, String, Date, UniqueConstraint, Text, Boolean
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .db import Base


class Restaurant(Base):
    __tablename__ = "restaurants"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    default_table_count: Mapped[int] = mapped_column(Integer, nullable=False, default=5)

    bookings: Mapped[list["Booking"]] = relationship("Booking", back_populates="restaurant")


class Booking(Base):
    __tablename__ = "bookings"
    __table_args__ = (
        UniqueConstraint("restaurant_id", "date", "time_slot", "client_name", name="uq_booking_dedup"),
    )

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    restaurant_id: Mapped[int] = mapped_column(ForeignKey("restaurants.id", ondelete="CASCADE"), nullable=False)
    date: Mapped[Date] = mapped_column(Date, nullable=False)
    time_slot: Mapped[str] = mapped_column(String(10), nullable=False)
    client_name: Mapped[str] = mapped_column(String(255), nullable=False)
    # New fields
    start_time: Mapped[str | None] = mapped_column(String(10), nullable=True)
    end_time: Mapped[str | None] = mapped_column(String(10), nullable=True)
    phone: Mapped[str | None] = mapped_column(String(32), nullable=True)
    guest_count: Mapped[int | None] = mapped_column(Integer, nullable=True)
    comment: Mapped[str | None] = mapped_column(Text, nullable=True)
    tags: Mapped[str | None] = mapped_column(Text, nullable=True)  # JSON-encoded list of strings
    deposit: Mapped[bool] = mapped_column(Boolean, nullable=False, default=False)

    restaurant: Mapped[Restaurant] = relationship("Restaurant", back_populates="bookings")


class RestaurantSettings(Base):
    __tablename__ = "restaurant_settings"

    restaurant_id: Mapped[int] = mapped_column(ForeignKey("restaurants.id", ondelete="CASCADE"), primary_key=True)
    host_choice: Mapped[str] = mapped_column(String(100), nullable=True)
    greeting_text: Mapped[str] = mapped_column(Text, nullable=True)
    info_text: Mapped[str] = mapped_column(Text, nullable=True)


```

```python
from typing import AsyncGenerator

from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
from sqlalchemy.orm import DeclarativeBase

from .config import settings


class Base(DeclarativeBase):
    pass


engine = create_async_engine(settings.DB_URL, echo=False, future=True)
AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)


async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with AsyncSessionLocal() as session:
        yield session


async def init_db() -> None:
    # Import models inside function to avoid circular imports
    from .models import Restaurant, Booking  # noqa: F401

    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
        # best-effort schema upgrades for new booking fields
        try:
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS start_time VARCHAR(10)")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS end_time VARCHAR(10)")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS phone VARCHAR(32)")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS guest_count INTEGER")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS comment TEXT")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS tags TEXT")
            await conn.exec_driver_sql("ALTER TABLE bookings ADD COLUMN IF NOT EXISTS deposit BOOLEAN DEFAULT FALSE NOT NULL")
        except Exception:
            pass

    # Seed default restaurant with id=1 if not exists
    from sqlalchemy import select

    async with AsyncSessionLocal() as session:
        result = await session.execute(select(Restaurant).where(Restaurant.id == 1))
        restaurant = result.scalar_one_or_none()
        if restaurant is None:
            session.add(Restaurant(id=1, name="Default Restaurant", default_table_count=5))
            await session.commit()


```

```python
from datetime import date
from typing import List, Optional

from pydantic import BaseModel, Field


class TokenResponse(BaseModel):
    access_token: str
    token_type: str = "bearer"


class LoginRequest(BaseModel):
    username: str
    password: str


class BookingCreate(BaseModel):
    restaurant_id: int = Field(..., ge=1)
    date: date
    time_slot: str  # retained for capacity counting
    client_name: str
    # New fields
    start_time: str | None = None
    end_time: str | None = None
    phone: str | None = None
    guest_count: int | None = Field(default=None, ge=1)
    comment: str | None = None
    tags: list[str] | None = None
    deposit: bool = False


class SlotInfo(BaseModel):
    time: str
    booked: int
    free: int


class SlotsResponse(BaseModel):
    restaurant_id: int
    date: date
    slots: List[SlotInfo]


class RestaurantSettingsIn(BaseModel):
    host_choice: str | None = None
    greeting_text: str | None = None
    info_text: str | None = None


class RestaurantSettingsOut(RestaurantSettingsIn):
    restaurant_id: int


class AssistantChatRequest(BaseModel):
    assistant_id: str
    message: str
    thread_id: str | None = None


class AssistantChatResponse(BaseModel):
    thread_id: str
    assistant_message: str


```

```python
from datetime import datetime
from typing import Dict, List

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy import Select, func, select
from sqlalchemy.ext.asyncio import AsyncSession

from ..auth import get_current_user
from ..cache import get_cached_slots, set_cached_slots
from ..config import settings
from ..db import get_db
from ..models import Booking, Restaurant
from ..schemas import BookingCreate, SlotInfo, SlotsResponse


router = APIRouter()


@router.get("/{restaurant_id}/{date}", response_model=SlotsResponse)
async def get_slots(restaurant_id: int, date: str, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    try:
        date_str = date
        try:
            parsed_date = datetime.strptime(date_str, "%Y-%m-%d").date()
        except ValueError:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid date format, expected YYYY-MM-DD")
        query_date = date_str  # keep as string for cache key
        # Check cache first
        cached = await get_cached_slots(restaurant_id, query_date)
        if cached is not None:
            return SlotsResponse(restaurant_id=restaurant_id, date=parsed_date, slots=[SlotInfo(**s) for s in cached])

        # Build from DB
        # Get restaurant to know default_table_count
        restaurant = await db.get(Restaurant, restaurant_id)
        if restaurant is None:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

        stmt: Select = (
            select(Booking.time_slot, func.count(Booking.id))
            .where(Booking.restaurant_id == restaurant_id)
            .where(Booking.date == parsed_date)
            .group_by(Booking.time_slot)
        )
        result = await db.execute(stmt)
        counts: Dict[str, int] = {row[0]: int(row[1]) for row in result.all()}

        slots: List[dict] = []
        for t in settings.TIME_SLOTS:
            booked = counts.get(t, 0)
            free = max(restaurant.default_table_count - booked, 0)
            slots.append({"time": t, "booked": booked, "free": free})

        # Cache result
        await set_cached_slots(restaurant_id, query_date, slots)

        return SlotsResponse(restaurant_id=restaurant_id, date=parsed_date, slots=[SlotInfo(**s) for s in slots])
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(e))


@router.post("", status_code=201)
async def create_booking(payload: BookingCreate, _: dict = Depends(get_current_user), db: AsyncSession = Depends(get_db)):
    # Ensure restaurant exists
    restaurant = await db.get(Restaurant, payload.restaurant_id)
    if restaurant is None:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Restaurant not found")

    # Check if time slot is valid
    if payload.time_slot not in settings.TIME_SLOTS:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid time slot")

    # Count existing bookings
    stmt: Select = (
        select(func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .where(Booking.time_slot == payload.time_slot)
    )
    result = await db.execute(stmt)
    current_count = int(result.scalar() or 0)
    if current_count >= restaurant.default_table_count:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="No free tables for selected slot")

    booking = Booking(
        restaurant_id=payload.restaurant_id,
        date=payload.date,
        time_slot=payload.time_slot,
        client_name=payload.client_name,
        start_time=payload.start_time,
        end_time=payload.end_time,
        phone=payload.phone,
        guest_count=payload.guest_count,
        comment=payload.comment,
        tags=','.join(payload.tags) if payload.tags else None,
        deposit=bool(payload.deposit),
    )
    db.add(booking)
    await db.commit()
    await db.refresh(booking)

    # Invalidate/update cache by recomputing slots for that date
    # Simpler: recompute and set cache now
    stmt_counts: Select = (
        select(Booking.time_slot, func.count(Booking.id))
        .where(Booking.restaurant_id == payload.restaurant_id)
        .where(Booking.date == payload.date)
        .group_by(Booking.time_slot)
    )
    res = await db.execute(stmt_counts)
    counts = {row[0]: int(row[1]) for row in res.all()}
    slots = []
    for t in settings.TIME_SLOTS:
        booked = counts.get(t, 0)
        free = max(restaurant.default_table_count - booked, 0)
        slots.append({"time": t, "booked": booked, "free": free})

    await set_cached_slots(payload.restaurant_id, str(payload.date), slots)

    return {"status": "ok", "booking_id": booking.id}


```

```typescriptreact
*** Begin Patch
*** Update File: /Users/alexgl/Documents/Projects/Snapyfit/0_AI_hostes_RND/CRM_Proto_v2/frontend/src/pages/Bookings.tsx
@@
   const [modalOpen, setModalOpen] = useState(false)
   const [clientName, setClientName] = useState('')
   const [selectedTime, setSelectedTime] = useState('')
+  const [startTime, setStartTime] = useState('')
+  const [endTime, setEndTime] = useState('')
+  const [phone, setPhone] = useState('')
+  const [guestCount, setGuestCount] = useState<number | ''>('')
+  const [comment, setComment] = useState('')
+  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
+  const [tags, setTags] = useState<string[]>([])
+  const [deposit, setDeposit] = useState(false)
@@
   const openModal = (time: string) => {
     setSelectedTime(time)
     setClientName('')
+    setStartTime(time)
+    setEndTime(time)
+    setPhone('')
+    setGuestCount('')
+    setComment('')
+    setTags([])
+    setDeposit(false)
     setModalOpen(true)
   }
@@
   const createBooking = async () => {
     try {
       await axios.post(
         `${API_URL}/bookings`,
-        { restaurant_id: restaurantId, date, time_slot: selectedTime, client_name: clientName },
+        {
+          restaurant_id: restaurantId,
+          date,
+          time_slot: selectedTime,
+          client_name: clientName,
+          start_time: startTime || null,
+          end_time: endTime || null,
+          phone: phone || null,
+          guest_count: typeof guestCount === 'number' ? guestCount : null,
+          comment: comment || null,
+          tags,
+          deposit,
+        },
         authHeaders
       )
       setModalOpen(false)
       await fetchSlots()
     } catch (err: any) {
       alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
     }
   }
@@
-          <div className="modal">
-            <h3 className="text-lg font-semibold mb-4">–ù–æ–≤–∞—è –±—Ä–æ–Ω—å</h3>
-              <div className="space-y-3">
-              <div>
-                <label className="block text-sm mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
-                <input className="input" value={clientName} onChange={e => setClientName(e.target.value)} />
-              </div>
-                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
-                <div>
-                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
-                  <Calendar value={date} onChange={setDate} />
-                </div>
-                <div>
-                  <label className="block text-sm mb-1">–í—Ä–µ–º—è</label>
-                  <input className="input" value={selectedTime} onChange={e => setSelectedTime(e.target.value)} />
-                </div>
-              </div>
-              <div className="flex gap-2 justify-end pt-2">
-                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
-                <button className="btn" onClick={createBooking} disabled={!clientName || !selectedTime}>–î–æ–±–∞–≤–∏—Ç—å</button>
-              </div>
-            </div>
-          </div>
+          <div className="modal">
+            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
+            <div className="space-y-4">
+              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
+                <div>
+                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
+                  <Calendar value={date} onChange={setDate} />
+                </div>
+                <div>
+                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
+                  <div className="grid grid-cols-2 gap-2">
+                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
+                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
+                  </div>
+                </div>
+              </div>
+
+              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
+                <div>
+                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
+                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
+                </div>
+                <div>
+                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
+                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
+                </div>
+              </div>
+
+              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
+                <div>
+                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
+                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
+                </div>
+                <div>
+                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
+                  <div className="flex items-center gap-3">
+                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
+                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
+                  </div>
+                </div>
+              </div>
+
+              <div>
+                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
+                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
+              </div>
+
+              <div>
+                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
+                <div className="flex flex-wrap gap-2">
+                  {TAG_OPTIONS.map(t => (
+                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
+                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
+                        if (e.target.checked) setTags(prev => [...prev, t])
+                        else setTags(prev => prev.filter(x => x !== t))
+                      }} />
+                      {t}
+                    </label>
+                  ))}
+                </div>
+              </div>
+
+              <div className="flex gap-2 justify-end pt-2">
+                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
+                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
+              </div>
+            </div>
+          </div>
           </div>
         </div>
       )}
     </div>
   )
 }
+
+function formatPhone(input: string): string {
+  const digits = input.replace(/\D/g, '')
+  let d = digits
+  if (d.startsWith('8')) d = '7' + d.slice(1)
+  if (!d.startsWith('7')) d = '7' + d
+  const p1 = d.slice(1, 4)
+  const p2 = d.slice(4, 7)
+  const p3 = d.slice(7, 9)
+  const p4 = d.slice(9, 11)
+  let out = '+7'
+  if (p1) out += ` (${p1}`
+  if (p1 && p1.length === 3) out += ')'
+  if (p2) out += ` ${p2}`
+  if (p3) out += `-${p3}`
+  if (p4) out += `-${p4}`
+  return out
+}
*** End Patch
```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const [startTime, setStartTime] = useState('')
  const [endTime, setEndTime] = useState('')
  const [phone, setPhone] = useState('')
  const [guestCount, setGuestCount] = useState<number | ''>('')
  const [comment, setComment] = useState('')
  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
  const [tags, setTags] = useState<string[]>([])
  const [deposit, setDeposit] = useState(false)
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setStartTime(time)
    setEndTime(time)
    setPhone('')
    setGuestCount('')
    setComment('')
    setTags([])
    setDeposit(false)
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        {
          restaurant_id: restaurantId,
          date,
          time_slot: selectedTime,
          client_name: clientName,
          start_time: startTime || null,
          end_time: endTime || null,
          phone: phone || null,
          guest_count: typeof guestCount === 'number' ? guestCount : null,
          comment: comment || null,
          tags,
          deposit,
        },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between w-full">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
                  <div className="grid grid-cols-2 gap-2">
                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
              </div>

              <div>
                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
                <div className="flex flex-wrap gap-2">
                  {TAG_OPTIONS.map(t => (
                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
                        if (e.target.checked) setTags(prev => [...prev, t])
                        else setTags(prev => prev.filter(x => x !== t))
                      }} />
                      {t}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}


```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const [startTime, setStartTime] = useState('')
  const [endTime, setEndTime] = useState('')
  const [phone, setPhone] = useState('')
  const [guestCount, setGuestCount] = useState<number | ''>('')
  const [comment, setComment] = useState('')
  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
  const [tags, setTags] = useState<string[]>([])
  const [deposit, setDeposit] = useState(false)
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setStartTime(time)
    setEndTime(time)
    setPhone('')
    setGuestCount('')
    setComment('')
    setTags([])
    setDeposit(false)
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        {
          restaurant_id: restaurantId,
          date,
          time_slot: selectedTime,
          client_name: clientName,
          start_time: startTime || null,
          end_time: endTime || null,
          phone: phone || null,
          guest_count: typeof guestCount === 'number' ? guestCount : null,
          comment: comment || null,
          tags,
          deposit,
        },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between w-full">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
                  <div className="grid grid-cols-2 gap-2">
                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
              </div>

              <div>
                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
                <div className="flex flex-wrap gap-2">
                  {TAG_OPTIONS.map(t => (
                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
                        if (e.target.checked) setTags(prev => [...prev, t])
                        else setTags(prev => prev.filter(x => x !== t))
                      }} />
                      {t}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function formatPhone(input: string): string {
  const digits = input.replace(/\D/g, '')
  let d = digits
  if (d.startsWith('8')) d = '7' + d.slice(1)
  if (!d.startsWith('7')) d = '7' + d
  const p1 = d.slice(1, 4)
  const p2 = d.slice(4, 7)
  const p3 = d.slice(7, 9)
  const p4 = d.slice(9, 11)
  let out = '+7'
  if (p1) out += ` (${p1}`
  if (p1 && p1.length === 3) out += ')'
  if (p2) out += ` ${p2}`
  if (p3) out += `-${p3}`
  if (p4) out += `-${p4}`
  return out
}


```

–°–¥–µ–ª–∞–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- –ë—ç–∫–µ–Ω–¥:
  - –ú–æ–¥–µ–ª—å `Booking` –¥–æ–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª—è–º–∏: `start_time`, `end_time`, `phone`, `guest_count`, `comment`, `tags` (—Å—Ç—Ä–æ–∫–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–∫ CSV), `deposit` (bool).
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã —á–µ—Ä–µ–∑ ALTER TABLE (–±–µ–∑–æ–ø–∞—Å–Ω–æ, IF NOT EXISTS).
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç `POST /bookings` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö.

- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`/bookings`):
  - –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ ¬´–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏¬ª.
  - –ü–æ–ª—è:
    - –í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞, type=time), –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –∫–ª–∞–¥–µ—Ç—Å—è –∫–∞–∫ `time_slot`.
    - –¢–µ–ª–µ—Ñ–æ–Ω —Å –º–∞—Å–∫–æ–π `+7 (...) ...-..-..`.
    - –ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ).
    - –ü–µ—Ä—Å–æ–Ω (—á–∏—Å–ª–æ).
    - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (textarea).
    - –¢–µ–≥–∏ (—á–µ–∫–±–æ–∫—Å—ã —Å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–æ–º).
    - –î–µ–ø–æ–∑–∏—Ç (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ¬´–ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞¬ª / ¬´–° –¥–µ–ø–æ–∑–∏—Ç–æ–º¬ª).
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ –≤ —Ç–µ–ª–µ.

–ü—Ä–æ–≤–µ—Ä—å
- –û—Ç–∫—Ä–æ–π ¬´–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è¬ª, –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –Ω–∞ —Å–ª–æ—Ç–µ.
- –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É, –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª ‚Äî –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è, —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ –æ–±–Ω–æ–≤–∏—Ç—Å—è.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–≥–∏ –∫–∞–∫ JSON –≤ –ë–î ‚Äî –ø–µ—Ä–µ–¥–µ–ª–∞—é `tags` –Ω–∞ JSONB. –¢–∞–∫–∂–µ –º–æ–≥—É –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ç–µ–≥–æ–≤ –∏–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

---

**User**

–°—É–ø–µ—Ä! –°–¥–µ–ª–∞–π —ç—Ç–æ –æ–∫–Ω–æ –≤ 2 —Ä–∞–∑–∞ —à–∏—Ä–µ

---

**Cursor**

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  @apply text-gray-900;
}

.btn {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-black text-white hover:bg-gray-800 transition-colors;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200;
}

.input {
  @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-300;
}

.modal-backdrop {
  @apply fixed inset-0 bg-black/30 flex items-center justify-center z-50;
}

.modal {
  @apply bg-white rounded-lg p-6 w-full max-w-4xl shadow-lg;
}


```

–°–¥–µ–ª–∞–ª –º–æ–¥–∞–ª–∫—É –≤–¥–≤–æ–µ —à–∏—Ä–µ: —É–≤–µ–ª–∏—á–∏–ª `max-w-md` –¥–æ `max-w-4xl`. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π ‚Äî –æ–∫–Ω–æ ¬´–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏¬ª —Ç–µ–ø–µ—Ä—å –∑–∞–º–µ—Ç–Ω–æ —à–∏—Ä–µ.

---

**User**

–≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ! –û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —á—Ç–æ –º–Ω–µ –Ω–∞–¥–æ: —Å–¥–µ–ª–∞–π —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É, –∞ —Ç–æ –æ–Ω–∏ –≤–ø–ª–æ—Ç–Ω—É—é –∑–∞–∂–∞—Ç—ã —Å–µ–π—á–∞—Å –∫ –≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–û–∫–Ω–æ —Å –ª–æ—Ç–∞–º–∏, –≤—ã–±–æ—Ä –¥–∞—Ç—ã), –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–¥–µ —á–∞—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞

---

**Cursor**

–î–æ–±–∞–≤–ª—è—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã —Å–≤–µ—Ä—Ö—É –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö `Bookings` –∏ `Settings`, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Å–æ–±–µ—Ä—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const [startTime, setStartTime] = useState('')
  const [endTime, setEndTime] = useState('')
  const [phone, setPhone] = useState('')
  const [guestCount, setGuestCount] = useState<number | ''>('')
  const [comment, setComment] = useState('')
  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
  const [tags, setTags] = useState<string[]>([])
  const [deposit, setDeposit] = useState(false)
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setStartTime(time)
    setEndTime(time)
    setPhone('')
    setGuestCount('')
    setComment('')
    setTags([])
    setDeposit(false)
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        {
          restaurant_id: restaurantId,
          date,
          time_slot: selectedTime,
          client_name: clientName,
          start_time: startTime || null,
          end_time: endTime || null,
          phone: phone || null,
          guest_count: typeof guestCount === 'number' ? guestCount : null,
          comment: comment || null,
          tags,
          deposit,
        },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mt-4 md:mt-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className="p-4 border rounded-md flex items-center justify-between w-full">
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
                  <div className="grid grid-cols-2 gap-2">
                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
              </div>

              <div>
                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
                <div className="flex flex-wrap gap-2">
                  {TAG_OPTIONS.map(t => (
                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
                        if (e.target.checked) setTags(prev => [...prev, t])
                        else setTags(prev => prev.filter(x => x !== t))
                      }} />
                      {t}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function formatPhone(input: string): string {
  const digits = input.replace(/\D/g, '')
  let d = digits
  if (d.startsWith('8')) d = '7' + d.slice(1)
  if (!d.startsWith('7')) d = '7' + d
  const p1 = d.slice(1, 4)
  const p2 = d.slice(4, 7)
  const p3 = d.slice(7, 9)
  const p4 = d.slice(9, 11)
  let out = '+7'
  if (p1) out += ` (${p1}`
  if (p1 && p1.length === 3) out += ')'
  if (p2) out += ` ${p2}`
  if (p3) out += `-${p3}`
  if (p4) out += `-${p4}`
  return out
}


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const triggerIndex = lines.findIndex(l => l.trim().toUpperCase().startsWith('INFO_TRIGGER='))
        if (triggerIndex >= 0) {
          const raw = lines[triggerIndex].trim()
          const toAppend = raw.slice(raw.indexOf('=') + 1).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          // Remove trigger line from assistant visible text
          assistantAccum = lines.filter((_, i) => i !== triggerIndex).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = JSON.parse(jsonStr) as { delta?: string; error?: string; done?: boolean; thread_id?: string }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4 md:mt-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–î–æ–±–∞–≤–∏–ª –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É:
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —Å `mt-4 md:mt-6`.
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—á–∞—Ç + —Ñ–æ—Ä–º–∞) —Ç–æ–∂–µ `mt-4 md:mt-6`.

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –±–ª–æ–∫–∏ –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞—é—Ç –∫ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é.

---

**User**

–ö–ª–∞—Å—Å! –¢–µ–ø–µ—Ä—å –µ—â–µ —Ç–∞–∫–∏–µ –ø—Ä–∞–≤–∫–∏:

1) –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" –ø—É—Å—Ç—å –±—É–¥–µ—Ç –±–µ–ª–∞—è —Å —Å–µ—Ä—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º
2) –ö–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å" –ø—É—Å—Ç—å –±—É–¥—É—Ç —Å–µ—Ä—ã–º–∏, –∞ –Ω–µ —á–µ—Ä–Ω—ã–º–∏
3) –ú–æ–∂–µ–º –≤ —Å–ª–æ—Ç–∞—Ö —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ –µ—Å–ª–∏ –∑–∞–Ω—è—Ç–æ 0 –∏–∑ 5, —Ç–æ –∑–∞–ª–∏–≤–∫–∞ –±–µ–ª–∞—è. –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ 5 –∏–∑ 5, —Ç–æ –∑–∞–ª–∏–≤–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–≤–µ—Ç–ª–æ –∫—Ä–∞—Å–Ω–æ–π

---

**Cursor**

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  @apply text-gray-900;
}

.btn {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-black text-white hover:bg-gray-800 transition-colors;
}

.btn-secondary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-gray-700 text-white hover:bg-gray-600 transition-colors;
}

.btn-outline {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-white text-gray-800 border border-gray-300 hover:bg-gray-50 transition-colors;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200;
}

.input {
  @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-300;
}

.modal-backdrop {
  @apply fixed inset-0 bg-black/30 flex items-center justify-center z-50;
}

.modal {
  @apply bg-white rounded-lg p-6 w-full max-w-4xl shadow-lg;
}


```

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const [startTime, setStartTime] = useState('')
  const [endTime, setEndTime] = useState('')
  const [phone, setPhone] = useState('')
  const [guestCount, setGuestCount] = useState<number | ''>('')
  const [comment, setComment] = useState('')
  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
  const [tags, setTags] = useState<string[]>([])
  const [deposit, setDeposit] = useState(false)
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setStartTime(time)
    setEndTime(time)
    setPhone('')
    setGuestCount('')
    setComment('')
    setTags([])
    setDeposit(false)
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        {
          restaurant_id: restaurantId,
          date,
          time_slot: selectedTime,
          client_name: clientName,
          start_time: startTime || null,
          end_time: endTime || null,
          phone: phone || null,
          guest_count: typeof guestCount === 'number' ? guestCount : null,
          comment: comment || null,
          tags,
          deposit,
        },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mt-4 md:mt-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn-outline" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className={`p-4 border rounded-md flex items-center justify-between w-full ${s.booked >= 5 ? 'bg-red-50' : 'bg-white'}`}>
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn-secondary" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
                  <div className="grid grid-cols-2 gap-2">
                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
              </div>

              <div>
                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
                <div className="flex flex-wrap gap-2">
                  {TAG_OPTIONS.map(t => (
                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
                        if (e.target.checked) setTags(prev => [...prev, t])
                        else setTags(prev => prev.filter(x => x !== t))
                      }} />
                      {t}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function formatPhone(input: string): string {
  const digits = input.replace(/\D/g, '')
  let d = digits
  if (d.startsWith('8')) d = '7' + d.slice(1)
  if (!d.startsWith('7')) d = '7' + d
  const p1 = d.slice(1, 4)
  const p2 = d.slice(4, 7)
  const p3 = d.slice(7, 9)
  const p4 = d.slice(9, 11)
  let out = '+7'
  if (p1) out += ` (${p1}`
  if (p1 && p1.length === 3) out += ')'
  if (p2) out += ` ${p2}`
  if (p3) out += `-${p3}`
  if (p4) out += `-${p4}`
  return out
}


```

```typescriptreact
import { useEffect, useMemo, useState } from 'react'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'
const ASSISTANT_ID = 'asst_vitxwiKAOhWiFHgynXl07lzT'

const HOSTESS_OPTIONS = ['–ê–Ω–Ω–∞', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–ò—Ä–∏–Ω–∞', '–î–º–∏—Ç—Ä–∏–π']

export default function SettingsPage() {
  const token = localStorage.getItem('token')
  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])
  const restaurantId = 1

  const [hostChoice, setHostChoice] = useState<string>('')
  const [greetingText, setGreetingText] = useState<string>('')
  const [infoText, setInfoText] = useState<string>('')
  const [saving, setSaving] = useState(false)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string>('')

  // Chat state (OpenAI Assistants via backend proxy)
  const [messages, setMessages] = useState<{ role: 'user' | 'assistant'; content: string }[]>([])
  const [input, setInput] = useState('')
  const [chatLoading, setChatLoading] = useState(false)
  const [threadId, setThreadId] = useState<string | null>(() => localStorage.getItem('assistant_thread_id'))

  const fetchSettings = async () => {
    try {
      setLoading(true)
      setError('')
      const res = await axios.get(`${API_URL}/restaurants/${restaurantId}/settings`, authHeaders)
      setHostChoice(res.data.host_choice || '')
      setGreetingText(res.data.greeting_text || '')
      setInfoText(res.data.info_text || '')
    } catch (e: any) {
      setError(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSettings()
  }, [])

  const saveSettings = async () => {
    try {
      setSaving(true)
      await axios.put(
        `${API_URL}/restaurants/${restaurantId}/settings`,
        { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: infoText || null },
        authHeaders
      )
    } catch (e: any) {
      alert(e?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏')
    } finally {
      setSaving(false)
    }
  }

  const sendMessage = async () => {
    const text = input.trim()
    if (!text) return
    setMessages(prev => [...prev, { role: 'user', content: text }])
    setInput('')
    try {
      setChatLoading(true)
      const response = await fetch(`${API_URL}/assistants/chat_stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: authHeaders.headers.Authorization },
        body: JSON.stringify({ assistant_id: ASSISTANT_ID, message: text, thread_id: threadId }),
      })

      if (!response.ok || !response.body) {
        throw new Error('Stream failed')
      }
      const reader = response.body.getReader()
      const decoder = new TextDecoder()
      let buffer = ''
      let assistantAccum = ''
      let nextThreadId: string | null = threadId

      const applyInfoTrigger = async (fullText: string) => {
        const lines = fullText.split('\n')
        const triggerIndex = lines.findIndex(l => l.trim().toUpperCase().startsWith('INFO_TRIGGER='))
        if (triggerIndex >= 0) {
          const raw = lines[triggerIndex].trim()
          const toAppend = raw.slice(raw.indexOf('=') + 1).trim()
          if (toAppend) {
            const newInfo = infoText ? `${infoText}\n${toAppend}` : toAppend
            setInfoText(newInfo)
            try {
              await axios.put(
                `${API_URL}/restaurants/${restaurantId}/settings`,
                { host_choice: hostChoice || null, greeting_text: greetingText || null, info_text: newInfo },
                authHeaders
              )
            } catch {}
          }
          // Remove trigger line from assistant visible text
          assistantAccum = lines.filter((_, i) => i !== triggerIndex).join('\n').trim()
          if (!assistantAccum) assistantAccum = '(–æ–±–Ω–æ–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)'
        }
      }

      // Optimistically add an empty assistant message to be updated as we stream
      let appended = false
      while (true) {
        const { value, done } = await reader.read()
        if (done) break
        buffer += decoder.decode(value, { stream: true })
        const parts = buffer.split('\n\n')
        buffer = parts.pop() || ''
        for (const chunk of parts) {
          if (!chunk.startsWith('data:')) continue
          const jsonStr = chunk.slice(5).trim()
          if (!jsonStr) continue
          try {
            const evt = JSON.parse(jsonStr) as { delta?: string; error?: string; done?: boolean; thread_id?: string }
            if (evt.thread_id && !nextThreadId) {
              nextThreadId = evt.thread_id
              setThreadId(nextThreadId)
              localStorage.setItem('assistant_thread_id', nextThreadId)
            }
            if (evt.delta) {
              assistantAccum += evt.delta
              if (!appended) {
                setMessages(prev => [...prev, { role: 'assistant', content: assistantAccum }])
                appended = true
              } else {
                setMessages(prev => {
                  const copy = [...prev]
                  copy[copy.length - 1] = { role: 'assistant', content: assistantAccum }
                  return copy
                })
              }
            }
            if (evt.done) {
              await applyInfoTrigger(assistantAccum)
            }
            if (evt.error) {
              throw new Error(evt.error)
            }
          } catch {}
        }
      }
    } catch (e: any) {
      const err = e?.response?.data?.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
      setMessages(prev => [...prev, { role: 'assistant', content: `–û—à–∏–±–∫–∞: ${err}` }])
    } finally {
      setChatLoading(false)
    }
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4 md:mt-6">
      {/* Chat */}
      <div className="card p-4 h-[70vh] flex flex-col">
        <h2 className="text-xl font-semibold mb-3">–ß–∞—Ç</h2>
        <div className="flex-1 overflow-auto space-y-2">
          {messages.length === 0 && (
            <div className="text-sm text-gray-500">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistants –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</div>
          )}
          {messages.map((m, i) => (
            <div key={i} className={`p-3 rounded-md ${m.role === 'user' ? 'bg-gray-100' : 'bg-white border'}`}>
              <div className="text-xs text-gray-500 mb-1">{m.role === 'user' ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}</div>
              <div className="whitespace-pre-wrap">{m.content}</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-2">
          <input className="input flex-1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() } }} />
          <button className="btn-secondary" onClick={sendMessage} disabled={chatLoading}>{chatLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'}</button>
        </div>
      </div>

      {/* Settings form */}
      <div className="card p-4">
        <h2 className="text-xl font-semibold mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : (
          <div className="space-y-5">
            <div>
              <div className="font-medium mb-1">–í—ã–±–æ—Ä —Ö–æ—Å—Ç–µ—Å</div>
              <select className="input" value={hostChoice} onChange={e => setHostChoice(e.target.value)}>
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                {HOSTESS_OPTIONS.map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
            </div>
            <div>
              <div className="font-medium mb-1">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div>
              <textarea className="input min-h-[100px]" value={greetingText} onChange={e => setGreetingText(e.target.value)} />
            </div>
            <div>
              <div className="font-medium mb-1">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ</div>
              <textarea className="input min-h-[140px]" value={infoText} onChange={e => setInfoText(e.target.value)} />
            </div>
            {error && <div className="text-red-600 text-sm">{error}</div>}
            <button className="btn-outline" onClick={saveSettings} disabled={saving}>{saving ? '–û–±–Ω–æ–≤–ª—è—é...' : '–û–±–Ω–æ–≤–∏—Ç—å'}</button>
          </div>
        )}
      </div>
    </div>
  )
}


```

–ì–æ—Ç–æ–≤–æ:
- ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª —Ç–µ–ø–µ—Ä—å –±–µ–ª–∞—è —Å —Å–µ—Ä—ã–º –∫–æ–Ω—Ç—É—Ä–æ–º (`btn-outline`) –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö.
- –í—Å–µ –∫–Ω–æ–ø–∫–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª —Å—Ç–∞–ª–∏ —Å–µ—Ä—ã–º–∏ (`btn-secondary`) ‚Äî –∏ –≤ —Å–ª–æ—Ç–∞—Ö, –∏ –≤ –º–æ–¥–∞–ª–∫–µ.
- –°–ª–æ—Ç—ã:
  - –ø—Ä–∏ 0/5 ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–ª—ã–º–∏ (–∫–∞–∫ –∏ –±—ã–ª–æ),
  - –ø—Ä–∏ 5/5 ‚Äî –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–º —Ñ–æ–Ω–æ–º (`bg-red-50`).

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–π –ø–æ—Ä–æ–≥/—Ü–≤–µ—Ç ‚Äî —Å–∫–∞–∂–∏, –ø–æ–¥–ø—Ä–∞–≤–ª—é.

---

**User**

–í—Å–µ –∫–ª–∞—Å—Å. –î–æ–±–∞–≤—å –º–Ω–µ –∫—É–¥–∞-—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—é POSTMAN –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–µ–∫–µ–Ω–¥–æ–º, —á—Ç–æ–±—ã –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ —Ç–∞–º –æ–ø–∏—Å–∞–Ω—ã –∏ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã

---

**Cursor**

```json
{
  "info": {
    "_postman_id": "a8e1c9ea-2c1c-4f5e-9d1b-collection-crm",
    "name": "Restaurant CRM API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Postman collection for Restaurant CRM backend (FastAPI)."
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Login (get JWT)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/auth/login", "host": ["{{baseUrl}}"], "path": ["auth", "login"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"password123\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "  const json = pm.response.json();",
                  "  if (json.access_token) { pm.environment.set('token', json.access_token); }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Bookings",
      "item": [
        {
          "name": "Get slots by date",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "url": { "raw": "{{baseUrl}}/bookings/{{restaurantId}}/{{date}}", "host": ["{{baseUrl}}"], "path": ["bookings", "{{restaurantId}}", "{{date}}"] }
          }
        },
        {
          "name": "Create booking",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/bookings", "host": ["{{baseUrl}}"], "path": ["bookings"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurant_id\": {{restaurantId}},\n  \"date\": \"{{date}}\",\n  \"time_slot\": \"18:00\",\n  \"client_name\": \"–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\",\n  \"start_time\": \"18:00\",\n  \"end_time\": \"20:00\",\n  \"phone\": \"+7 (915) 123-45-67\",\n  \"guest_count\": 4,\n  \"comment\": \"–û–∫–Ω–æ —É –æ–∫–Ω–∞\",\n  \"tags\": [\"–ü–∞—Ä–∫–æ–≤–∫–∞\"],\n  \"deposit\": false\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Restaurant Settings",
      "item": [
        {
          "name": "Get settings",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" }
            ],
            "url": { "raw": "{{baseUrl}}/restaurants/{{restaurantId}}/settings", "host": ["{{baseUrl}}"], "path": ["restaurants", "{{restaurantId}}", "settings"] }
          }
        },
        {
          "name": "Update settings",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/restaurants/{{restaurantId}}/settings", "host": ["{{baseUrl}}"], "path": ["restaurants", "{{restaurantId}}", "settings"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"host_choice\": \"–ê–Ω–Ω–∞\",\n  \"greeting_text\": \"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\",\n  \"info_text\": \"–ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞.\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Assistants (OpenAI)",
      "item": [
        {
          "name": "Chat (single message)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "Bearer {{token}}" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{baseUrl}}/assistants/chat", "host": ["{{baseUrl}}"], "path": ["assistants", "chat"] },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"assistant_id\": \"{{assistantId}}\",\n  \"message\": \"–ü—Ä–∏–≤–µ—Ç!\",\n  \"thread_id\": {{#threadId}}\"{{threadId}}\"{{/threadId}}{{^threadId}}null{{/threadId}}\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "  const json = pm.response.json();",
                  "  if (json.thread_id) { pm.environment.set('threadId', json.thread_id); }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:8000" },
    { "key": "restaurantId", "value": "1" },
    { "key": "date", "value": "2025-01-01" },
    { "key": "assistantId", "value": "asst_vitxwiKAOhWiFHgynXl07lzT" },
    { "key": "threadId", "value": "" },
    { "key": "token", "value": "" }
  ]
}


```

```markdown
### Restaurant CRM (v1)

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP CRM –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React + Vite + Tailwind), –±—ç–∫–µ–Ω–¥ (FastAPI), PostgreSQL, Redis. –ó–∞–ø—É—Å–∫ –≤ Docker Compose. –ï—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT), –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Docker Compose.
2. –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
docker-compose up --build
```

3. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:5173`.
4. –í–æ–π–¥–∏—Ç–µ: –ª–æ–≥–∏–Ω `admin`, –ø–∞—Ä–æ–ª—å `password123`.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `frontend/` ‚Äî React + Vite + Tailwind UI
- `backend/` ‚Äî FastAPI + SQLAlchemy + Redis + JWT
- `docker-compose.yml` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

- **Backend**
  - `DB_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db`)
  - `REDIS_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://redis:6379/0`)
  - `JWT_SECRET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `supersecretjwt`)
  - `JWT_ALGORITHM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `HS256`)
  - `ADMIN_USERNAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`)
  - `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `password123`)
  - `FRONTEND_ORIGIN` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:5173`)
  - `OPENAI_API_KEY` (–∫–ª—é—á OpenAI, –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
- **Frontend**
  - `VITE_API_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)
  - `VITE_ASSISTANT_ID` (ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI –¥–ª—è —á–∞—Ç–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–º–æ ID)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã:

- `restaurants`
  - `id` (PK)
  - `name`
  - `default_table_count` (int, –¥–µ—Ñ–æ–ª—Ç–Ω–æ 5)
- `bookings`
  - `id` (PK)
  - `restaurant_id` (FK -> restaurants.id)
  - `date` (date)
  - `time_slot` (string, –Ω–∞–ø—Ä–∏–º–µ—Ä `18:00`)
  - `client_name` (string)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω `id=1` —Å `default_table_count=5`.

### API

–ë–∞–∑–æ–≤—ã–π URL: `http://localhost:8000`

- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
  - `POST /auth/login`
    - –í—Ö–æ–¥: `{ "username": "admin", "password": "password123" }`
    - –û—Ç–≤–µ—Ç: `{ "access_token": "...", "token_type": "bearer" }`
- **–°–ª–æ—Ç—ã –ø–æ –¥–∞—Ç–µ**
  - `GET /bookings/{restaurant_id}/{date}` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –ü—Ä–∏–º–µ—Ä: `/bookings/1/2025-01-01`
  - –û—Ç–≤–µ—Ç: `{ restaurant_id, date, slots: [{ time, booked, free }] }`
  - –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Redis –∫–ª—é—á–æ–º `slots:{restaurant_id}:{date}` –Ω–∞ 1 —á–∞—Å
- **–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
  - `POST /bookings` (—Ç—Ä–µ–±—É–µ—Ç Header `Authorization: Bearer <token>`)
  - –í—Ö–æ–¥: `{ "restaurant_id": 1, "date": "2025-01-01", "time_slot": "18:00", "client_name": "–ò–≤–∞–Ω" }`
  - –û—Ç–≤–µ—Ç: `{ "status": "ok", "booking_id": <id> }`

- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**
  - `GET /restaurants/{restaurant_id}/settings` (JWT)
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`
  - `PUT /restaurants/{restaurant_id}/settings` (JWT)
    - –í—Ö–æ–¥: `{ host_choice: string|null, greeting_text: string|null, info_text: string|null }`
    - –û—Ç–≤–µ—Ç: `{ restaurant_id, host_choice, greeting_text, info_text }`

- **–ß–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (OpenAI Assistants v2, –ø—Ä–æ–∫—Å–∏)**
  - `POST /assistants/chat` (JWT)
    - –í—Ö–æ–¥: `{ assistant_id: string, message: string, thread_id?: string }`
    - –û—Ç–≤–µ—Ç: `{ thread_id: string, assistant_message: string }`
    - –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `OPENAI_API_KEY` –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
  - `POST /assistants/chat_stream` (JWT, Server-Sent Events)
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–æ–∫ `text/event-stream` —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –≤–∏–¥–∞ `data: { "delta": "..." }` –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º `data: { "done": true, "thread_id": "..." }`
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.

### –ö—ç—à Redis

- –ö–ª—é—á–∏: `slots:{restaurant_id}:{date}`
- –ó–Ω–∞—á–µ–Ω–∏–µ: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º `{ time: "18:00", booked: 2, free: 3 }`
- TTL: 3600 —Å–µ–∫—É–Ω–¥

### UI

- –°–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã
- –°–∞–π–¥–±–∞—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –î–∞—à–±–æ—Ä–¥
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ —Å–ª–æ—Ç–æ–≤ —Å –º–æ–¥–∞–ª–∫–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –º—É–ª—å—Ç–∏-—Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤: —Ç–æ–∫–µ–Ω –≤–∫–ª—é—á–∞–µ—Ç `restaurant_id`, —Ç–∞–±–ª–∏—Ü–∞ `restaurants`, —Å–≤—è–∑—å —Å `bookings`.
- –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–∏, –∞ —Ç–∞–∫–∂–µ RBAC –∏ —Ä–µ–∞–ª—å–Ω—ã–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ª–æ–≥–∏–Ω.

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ Docker

- Backend
  ```bash
  cd backend
  python -m venv .venv && source .venv/bin/activate
  pip install -r requirements.txt
  export DB_URL=postgresql+asyncpg://crm_user:crm_password@localhost:5432/crm_db
  export REDIS_URL=redis://localhost:6379/0
  uvicorn app.main:app --reload
  ```
- Frontend
  ```bash
  cd frontend
  npm i
  npm run dev
  ```

### Postman

- –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `postman/Restaurant_CRM.postman_collection.json`.
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:
  - `baseUrl` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `http://localhost:8000`)
  - `restaurantId` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1`)
  - `date` (–ø—Ä–∏–º–µ—Ä `2025-01-01`)
  - `assistantId` (ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ OpenAI)
  - `threadId` (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É)
  - `token` (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)

### –õ–∏—Ü–µ–Ω–∑–∏—è

MIT


```

–î–æ–±–∞–≤–∏–ª –∫–æ–ª–ª–µ–∫—Ü–∏—é Postman.

–ì–¥–µ –Ω–∞–π—Ç–∏
- postman/Restaurant_CRM.postman_collection.json

–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏
- Auth:
  - POST /auth/login (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç token –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏)
- Bookings:
  - GET /bookings/{restaurant_id}/{date}
  - POST /bookings (—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏: –≤—Ä–µ–º—è-–¥–∏–∞–ø–∞–∑–æ–Ω, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è, –ø–µ—Ä—Å–æ–Ω, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Ç–µ–≥–∏, –¥–µ–ø–æ–∑–∏—Ç)
- Restaurant Settings:
  - GET /restaurants/{restaurant_id}/settings
  - PUT /restaurants/{restaurant_id}/settings
- Assistants:
  - POST /assistants/chat (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç thread_id –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
- baseUrl: http://localhost:8000
- restaurantId: 1
- date: 2025-01-01
- assistantId: asst_vitxwiKAOhWiFHgynXl07lzT
- threadId: –ø—É—Å—Ç–æ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
- token: –ø—É—Å—Ç–æ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)

README –æ–±–Ω–æ–≤–∏–ª —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.

---

**User**

–æ—Ñ–∏–≥–µ–Ω–Ω–æ. –ê –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ–±—ã –æ–±–Ω–≤–æ–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º? –ú–æ–∂–µ—Ç —á—Ç–æ–±—ã –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ, –∞ —Å–∞–º–æ –±—ã –æ–ø—Ä–∞—à–∏–≤–∞–ª–æ –±–µ–∫–µ–Ω–¥

---

**Cursor**

```typescriptreact
import axios from 'axios'
import { useEffect, useMemo, useState } from 'react'
import Calendar from '../components/Calendar'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000'

type Slot = { time: string; booked: number; free: number }

export default function BookingsPage() {
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10))
  const [slots, setSlots] = useState<Slot[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [modalOpen, setModalOpen] = useState(false)
  const [clientName, setClientName] = useState('')
  const [selectedTime, setSelectedTime] = useState('')
  const [startTime, setStartTime] = useState('')
  const [endTime, setEndTime] = useState('')
  const [phone, setPhone] = useState('')
  const [guestCount, setGuestCount] = useState<number | ''>('')
  const [comment, setComment] = useState('')
  const TAG_OPTIONS = ['–ü–∞—Ä–∫–æ–≤–∫–∞', '–°–µ–º–µ–π–Ω–æ–µ', '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–æ–µ', 'VIP']
  const [tags, setTags] = useState<string[]>([])
  const [deposit, setDeposit] = useState(false)
  const token = localStorage.getItem('token')
  const restaurantId = 1

  const authHeaders = useMemo(() => ({ headers: { Authorization: `Bearer ${token}` } }), [token])

  const fetchSlots = async () => {
    setLoading(true)
    setError('')
    try {
      const res = await axios.get(`${API_URL}/bookings/${restaurantId}/${date}`, authHeaders)
      setSlots(res.data.slots)
    } catch (err: any) {
      setError(err?.response?.data?.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ—Ç—ã')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSlots()
  }, [date])

  // Auto refresh slots periodically
  useEffect(() => {
    const id = setInterval(() => {
      fetchSlots()
    }, 15000)
    return () => clearInterval(id)
  }, [date])

  const openModal = (time: string) => {
    setSelectedTime(time)
    setClientName('')
    setStartTime(time)
    setEndTime(time)
    setPhone('')
    setGuestCount('')
    setComment('')
    setTags([])
    setDeposit(false)
    setModalOpen(true)
  }

  const createBooking = async () => {
    try {
      await axios.post(
        `${API_URL}/bookings`,
        {
          restaurant_id: restaurantId,
          date,
          time_slot: selectedTime,
          client_name: clientName,
          start_time: startTime || null,
          end_time: endTime || null,
          phone: phone || null,
          guest_count: typeof guestCount === 'number' ? guestCount : null,
          comment: comment || null,
          tags,
          deposit,
        },
        authHeaders
      )
      setModalOpen(false)
      await fetchSlots()
    } catch (err: any) {
      alert(err?.response?.data?.detail || '–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
    }
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mt-4 md:mt-6">
      <div className="md:col-span-1 order-1 md:order-none">
        <h2 className="font-semibold mb-2">–í—ã–±–æ—Ä –¥–∞—Ç—ã</h2>
        <Calendar value={date} onChange={setDate} />
      </div>
      <div className="md:col-span-3 card p-4 order-2 md:order-none">
        <div className="flex items-center justify-between mb-4">
          <h2 className="font-semibold">–°–ª–æ—Ç—ã –Ω–∞ {date}</h2>
          <button className="btn-outline" onClick={fetchSlots}>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {loading ? (
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        ) : error ? (
          <div className="text-red-600">{error}</div>
        ) : (
          <div className="flex flex-col gap-3">
            {slots.map((s) => (
              <div key={s.time} className={`p-4 border rounded-md flex items-center justify-between w-full ${s.booked >= 5 ? 'bg-red-50' : 'bg-white'}`}>
                <div>
                  <div className="text-lg font-medium">{s.time}</div>
                  <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç–æ: {s.booked} ‚Ä¢ –°–≤–æ–±–æ–¥–Ω–æ: {s.free}</div>
                </div>
                <button className="btn-secondary" onClick={() => openModal(s.time)} disabled={s.free <= 0}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {modalOpen && (
        <div className="modal-backdrop">
          <div className="modal">
            <h3 className="text-lg font-semibold mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–î–∞—Ç–∞</label>
                  <Calendar value={date} onChange={setDate} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–í—Ä–µ–º—è (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
                  <div className="grid grid-cols-2 gap-2">
                    <input className="input" type="time" value={startTime} onChange={e => { setStartTime(e.target.value); setSelectedTime(e.target.value) }} />
                    <input className="input" type="time" value={endTime} onChange={e => setEndTime(e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                  <input className="input" placeholder="+7 (___) ___-__-__" value={phone} onChange={e => setPhone(formatPhone(e.target.value))} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–ë—Ä–æ–Ω—å –Ω–∞ –∏–º—è*</label>
                  <input className="input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" value={clientName} onChange={e => setClientName(e.target.value)} />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">–ü–µ—Ä—Å–æ–Ω</label>
                  <input className="input" type="number" min={1} placeholder="4" value={guestCount} onChange={e => setGuestCount(e.target.value ? parseInt(e.target.value) : '')} />
                </div>
                <div>
                  <label className="block text-sm mb-1">–î–µ–ø–æ–∑–∏—Ç</label>
                  <div className="flex items-center gap-3">
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={!deposit} onChange={() => setDeposit(false)} /> –ë–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞</label>
                    <label className="inline-flex items-center gap-2"><input type="radio" name="deposit" checked={deposit} onChange={() => setDeposit(true)} /> –° –¥–µ–ø–æ–∑–∏—Ç–æ–º</label>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea className="input min-h-[90px]" value={comment} onChange={e => setComment(e.target.value)} />
              </div>

              <div>
                <label className="block text-sm mb-2">–¢–µ–≥–∏</label>
                <div className="flex flex-wrap gap-2">
                  {TAG_OPTIONS.map(t => (
                    <label key={t} className="inline-flex items-center gap-2 border rounded-md px-2 py-1">
                      <input type="checkbox" checked={tags.includes(t)} onChange={(e) => {
                        if (e.target.checked) setTags(prev => [...prev, t])
                        else setTags(prev => prev.filter(x => x !== t))
                      }} />
                      {t}
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-2 justify-end pt-2">
                <button className="px-4 py-2 rounded-md border" onClick={() => setModalOpen(false)}>–û—Ç–º–µ–Ω–∞</button>
                <button className="btn" onClick={createBooking} disabled={!clientName}>–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function formatPhone(input: string): string {
  const digits = input.replace(/\D/g, '')
  let d = digits
  if (d.startsWith('8')) d = '7' + d.slice(1)
  if (!d.startsWith('7')) d = '7' + d
  const p1 = d.slice(1, 4)
  const p2 = d.slice(4, 7)
  const p3 = d.slice(7, 9)
  const p4 = d.slice(9, 11)
  let out = '+7'
  if (p1) out += ` (${p1}`
  if (p1 && p1.length === 3) out += ')'
  if (p2) out += ` ${p2}`
  if (p3) out += `-${p3}`
  if (p4) out += `-${p4}`
  return out
}


```

–°–¥–µ–ª–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Ç–µ–ø–µ—Ä—å –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –±–µ–∫–µ–Ω–¥ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª). –ö–Ω–æ–ø–∫—É ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª –æ—Å—Ç–∞–≤–∏–ª –Ω–∞ –º–µ—Å—Ç–µ ‚Äî –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–æ–¥—Ç—è–Ω—É—Ç—å —Å—Ä–∞–∑—É.

---

**User**

–í—Å–µ –æ—Ç–ª–∏—á–Ω–æ. –ü–æ–º–æ–≥–∏ –Ω–∞ –≥–∏—Ç—Ö–∞–± —Ç–µ–ø–µ—Ä—å –º–Ω–µ –≤—Å–µ —ç—Ç–æ –∑–∞–ª–∏—Ç—å –≤ –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

---

**Cursor**

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ª–æ–∫–∞–ª—å–Ω–æ, –¥–æ–±–∞–≤–ª—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π .gitignore –∏ —Å–¥–µ–ª–∞—é –ø–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç. –ó–∞—Ç–µ–º –¥–∞–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –Ω–æ–≤–æ–º—É GitHub-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é –∏ –ø—É—à–∞. –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—É—â—É –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.

```ignore
# OS
.DS_Store
Thumbs.db

# Env / secrets
.env
.env.*
*.env

# Node / frontend
frontend/node_modules/
frontend/dist/
frontend/.vite/
frontend/.parcel-cache/
frontend/.eslintcache

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Editor
.vscode/
.idea/
*.swp

# Python / backend
backend/.venv/
backend/venv/
__pycache__/
*.pyc
*.pyo
*.pyd
.pytest_cache/
.coverage
htmlcov/
.mypy_cache/

# Docker
**/.cache/

# Misc
coverage/


```

–î–µ–ª–∞—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é –Ω–∞ GitHub —Ç–∞–∫:
1) –°–æ–∑–¥–∞–π –ø—É—Å—Ç–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub (–±–µ–∑ README/–ª–∏—Ü–µ–Ω–∑–∏–∏), –∑–∞–ø–æ–º–Ω–∏ URL –≤–∏–¥–∞: git@github.com:USERNAME/REPO.git –∏–ª–∏ https://github.com/USERNAME/REPO.git
2) –í—ã–ø–æ–ª–Ω–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ:
- SSH:
  ```bash
  git remote add origin git@github.com:USERNAME/REPO.git
  git branch -M main
  git push -u origin main
  ```
- HTTPS:
  ```bash
  git remote add origin https://github.com/USERNAME/REPO.git
  git branch -M main
  git push -u origin main
  ```

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–π –º–Ω–µ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ‚Äî –¥–æ–±–∞–≤–ª—é remote –∏ –∑–∞–ø—É—à—É –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∑–∞ —Ç–µ–±—è.

```shellscript
  git remote add origin git@github.com:USERNAME/REPO.git
  git branch -M main
  git push -u origin main
```

```shellscript
  git remote add origin https://github.com/USERNAME/REPO.git
  git branch -M main
  git push -u origin main
```

---

**User**

@https://github.com/EVRAG/Hostes_CRM.git 

---

**Cursor**

–ì–æ—Ç–æ–≤–æ. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤—è–∑–∞–Ω –∏ –∑–∞–ø—É—à–µ–Ω:
- origin: https://github.com/EVRAG/Hostes_CRM.git
- –≤–µ—Ç–∫–∞: main

–ú–æ–∂–µ—à—å –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Äî –≤–µ—Å—å –∫–æ–¥, Docker Compose, README –∏ Postman-–∫–æ–ª–ª–µ–∫—Ü–∏—è —É–∂–µ —Ç–∞–º.

---

**User**

–ö–ª–∞—Å—Å! –ù–∞ Render.com –∫–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–Ω–µ —Å–µ—Ä–≤–µ—Ä?
–Ø —Å–æ–∑–¥–∞–ª –Ω–æ–≤—ã–π WebService, —è–∑—ã–∫ - –î–æ–∫–µ—Ä, —á–µ—Ç –Ω–∞–¥–æ –µ—â–µ —Ç–∞–º –ø—Ä–æ–ø–∏—Å—ã–≤–∞—Ç—å?

---

**Cursor**

–ù–∏–∂–µ ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ —Ä–∞–±–æ—á–∏–π —Ä–µ—Ü–µ–ø—Ç –¥–µ–ø–ª–æ—è –Ω–∞ Render –±–µ–∑ docker-compose (Render –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç compose). –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –±—ç–∫–µ–Ω–¥ –∫–∞–∫ Docker Web Service, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–∞–∫ Static Site, –ë–î –∏ Redis ‚Äî Managed —Å–µ—Ä–≤–∏—Å—ã Render.

–®–∞–≥–∏

1) Backend (Web Service, Docker)
- New > Web Service
- Repository: —Ç–≤–æ–π GitHub `EVRAG/Hostes_CRM`
- Build Mode: Docker
- Root Directory: backend
- Dockerfile Path: backend/Dockerfile
- Start Command: –ø—É—Å—Ç–æ (–≤ Dockerfile —É–∂–µ `uvicorn app.main:app --host 0.0.0.0 --port 8000`)
- Port: 8000
- Environment:
  - DB_URL: —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Render PostgreSQL –≤ —Ñ–æ—Ä–º–∞—Ç–µ postgresql+asyncpg://USER:PASSWORD@HOST:PORT/DB
  - REDIS_URL: —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Render Redis, –Ω–∞–ø—Ä–∏–º–µ—Ä rediss://default:PASSWORD@HOST:PORT
  - JWT_SECRET: –ø—Ä–∏–¥—É–º–∞–π –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
  - FRONTEND_ORIGIN: –∞–¥—Ä–µ—Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ Render (–∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—à—å —Ñ—Ä–æ–Ω—Ç, –æ–±–Ω–æ–≤–∏—à—å —Å—é–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä https://hostes-frontend.onrender.com)
  - OPENAI_API_KEY: —Ç–≤–æ–π –∫–ª—é—á
- Deploy

2) PostgreSQL (Managed Database)
- New > PostgreSQL
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–π–¥–∏ –≤ Connection –∏ —Å–æ–±–µ—Ä–∏ DB_URL –≤—Ä—É—á–Ω—É—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ postgresql+asyncpg://...:
  - USER, PASSWORD, HOST, PORT, DB NAME –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ –ë–î
  - –ü—Ä–∏–º–µ—Ä: postgresql+asyncpg://render_user:pass@postgres.render.com:5432/render_db
- –í—Å—Ç–∞–≤—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DB_URL —É –±—ç–∫–µ–Ω–¥–∞ (Settings > Environment)
- –†–µ—Å—Ç–∞—Ä—Ç –±—ç–∫–µ–Ω–¥–∞

3) Redis (Managed Redis)
- New > Redis
- –ò—Å–ø–æ–ª—å–∑—É–π –≤–Ω–µ—à–Ω–∏–π TLS URL (–æ–±—ã—á–Ω–æ rediss://default:PASSWORD@HOST:PORT)
- –í—Å—Ç–∞–≤—å –≤ REDIS_URL —É –±—ç–∫–µ–Ω–¥–∞
- –†–µ—Å—Ç–∞—Ä—Ç –±—ç–∫–µ–Ω–¥–∞

4) Frontend (Static Site)
- New > Static Site
- Repository: —Ç–æ—Ç –∂–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- Root Directory: frontend
- Build Command: npm ci && npm run build
- Publish Directory: dist
- Environment:
  - VITE_API_URL: –ø—É–±–ª–∏—á–Ω—ã–π URL –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Render, –Ω–∞–ø—Ä–∏–º–µ—Ä https://hostes-backend.onrender.com
- Deploy

5) CORS
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ —É –±—ç–∫–µ–Ω–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è FRONTEND_ORIGIN —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-URL –Ω–∞ Render. –ò–Ω–∞—á–µ –±—Ä–∞—É–∑–µ—Ä –±—É–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.
- –í –∫–æ–¥–µ CORS —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ FRONTEND_ORIGIN.

6) OpenAI
- –ù–∞ –±—ç–∫–µ–Ω–¥–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–Ω OPENAI_API_KEY.
- –°—Ç—Ä–∏–º–∏–Ω–≥ SSE –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è; –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ /assistants/chat_stream.

–ü—Ä–æ–≤–µ—Ä–∫–∞
- Backend: –æ—Ç–∫—Ä–æ–π https://<backend>.onrender.com/docs ‚Äî Swagger –¥–æ–ª–∂–µ–Ω –≥—Ä—É–∑–∏—Ç—å—Å—è.
- Frontend: –æ—Ç–∫—Ä–æ–π https://<frontend>.onrender.com ‚Äî –∑–∞–ª–æ–≥–∏–Ω—å—Å—è admin/password123, –ø—Ä–æ–≤–µ—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —á–∞—Ç.

–ü–æ–¥—Å–∫–∞–∑–∫–∏/–¥–µ—Ç–∞–ª–∏
- –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î: –±—ç–∫–µ–Ω–¥ —Å–∞–º —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã (init_db) –∏ –º–∏–≥—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –±—Ä–æ–Ω–∏ —á–µ—Ä–µ–∑ ALTER TABLE IF NOT EXISTS.
- –ü–æ—Ä—Ç –±—ç–∫–µ–Ω–¥–∞: 8000 (–≤ Dockerfile –∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render Web Service).
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ Render —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞.
- –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º docker-compose, –≤ –ø—Ä–æ–¥–µ ‚Äî —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã Render.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å render.yaml (Render Blueprint) –ø–æ–¥ —Ç–≤–æ–∏ –∏–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚Äî —Å–∫–∞–∂–∏, –∫–∞–∫ –Ω–∞–∑–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã (backend, frontend, postgres, redis) –∏ —è –¥–æ–±–∞–≤–ª—é —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ.

---

**User**

—Ç–∞–∫, –∞ –∫–∞–∫-—Ç–æ –ø—Ä–æ—â–µ –Ω–µ–ª—å–∑—è –≥–¥–µ-—Ç–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å? –Ø –∂–µ —É —Å–µ–±—è –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞—é –∏ –≤—Å–µ

---

**Cursor**

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± ‚Äî –≤–∑—è—Ç—å –ª—é–±–æ–π VPS –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—à docker-compose —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ.

–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é): VPS + docker compose
1) –ü–æ–¥–Ω–∏–º–∏ VPS (Hetzner/DO/AWS Lightsail/–Ø–û Cloud), –ø–æ–ª—É—á–∏ IP –∏–ª–∏ –¥–æ–º–µ–Ω.

2) –£—Å—Ç–∞–Ω–æ–≤–∏ Docker:
- Ubuntu/Debian:
  ```bash
  curl -fsSL https://get.docker.com | sh
  sudo usermod -aG docker $USER
  newgrp docker
  sudo apt-get install -y docker-compose-plugin
  ```

3) –°–∫–ª–æ–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å .env:
- ```bash
  git clone https://github.com/EVRAG/Hostes_CRM.git
  cd Hostes_CRM
  ```
- –°–æ–∑–¥–∞–π .env —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ–¥ –≤–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø:
  ```bash
  cat > .env << 'EOF'
  POSTGRES_USER=crm_user
  POSTGRES_PASSWORD=crm_password
  POSTGRES_DB=crm_db

  # –í–∞–∂–Ω–æ: —Ç—É—Ç —É–∫–∞–∂–∏ –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞ (IP/–¥–æ–º–µ–Ω VPS)
  VITE_API_URL=http://YOUR_DOMAIN_OR_IP:8000
  FRONTEND_ORIGIN=http://YOUR_DOMAIN_OR_IP:5173

  DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
  REDIS_URL=redis://redis:6379/0

  JWT_SECRET=please_change_me
  JWT_ALGORITHM=HS256

  OPENAI_API_KEY=sk-... (—Ç–≤–æ–π –∫–ª—é—á)
  EOF
  ```

4) –ó–∞–ø—É—Å—Ç–∏:
- ```bash
  docker compose up -d --build
  ```
- –û—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://YOUR_DOMAIN_OR_IP:5173
- –õ–æ–≥–∏–Ω: admin / password123

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å HTTPS/–¥–æ–º–µ–Ω ‚Äî –¥–æ–±–∞–≤—å –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Caddy/Traefik/NGINX) –ø–æ–≤–µ—Ä—Ö –Ω–∞—à–∏—Ö –ø–æ—Ä—Ç–æ–≤ 5173/8000. –≠—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ IP –∏ –ø–æ—Ä—Ç–æ–≤.
- –î–∞–Ω–Ω—ã–µ Postgres —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ volume `db_data` –Ω–∞ VPS.
- –ü—Ä–∏ —Å–º–µ–Ω–µ IP/–¥–æ–º–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—å –ø–∞—Ä—ã:
  - —Ñ—Ä–æ–Ω—Ç: VITE_API_URL
  - –±—ç–∫–µ–Ω–¥: FRONTEND_ORIGIN

–í–∞—Ä–∏–∞–Ω—Ç B (–æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ —á–µ—Ä–µ–∑ GUI): CapRover/ Coolify –Ω–∞ VPS
- –£—Å—Ç–∞–Ω–æ–≤–∏ CapRover –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ VPS, –∑–∞–π–¥–∏ –≤ –ø–∞–Ω–µ–ª—å, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –Ω–∞—à `docker-compose.yml` ‚Äî –∏ –æ–Ω —Å–∞–º –ø–æ–¥–Ω–∏–º–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã, –≤—ã–¥–∞—Å—Ç –¥–æ–º–µ–Ω—ã/SSL –ø–æ –∫–Ω–æ–ø–∫–µ. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –Ω–∞–ø–∏—à—É –∫–æ—Ä–æ—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–¥ CapRover.

–°–∫–∞–∂–∏, –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—à—å (VPS –≤—Ä—É—á–Ω—É—é –∏–ª–∏ CapRover) ‚Äî –¥–∞–º —Ç–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ —Ç–≤–æ–π IP/–¥–æ–º–µ–Ω.

```shellscript
  curl -fsSL https://get.docker.com | sh
  sudo usermod -aG docker $USER
  newgrp docker
  sudo apt-get install -y docker-compose-plugin
```

```plaintext
- –°–æ–∑–¥–∞–π .env —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ–¥ –≤–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø:
  ```bash
  cat > .env << 'EOF'
  POSTGRES_USER=crm_user
  POSTGRES_PASSWORD=crm_password
  POSTGRES_DB=crm_db

  # –í–∞–∂–Ω–æ: —Ç—É—Ç —É–∫–∞–∂–∏ –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞ (IP/–¥–æ–º–µ–Ω VPS)
  VITE_API_URL=http://YOUR_DOMAIN_OR_IP:8000
  FRONTEND_ORIGIN=http://YOUR_DOMAIN_OR_IP:5173

  DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
  REDIS_URL=redis://redis:6379/0

  JWT_SECRET=please_change_me
  JWT_ALGORITHM=HS256

  OPENAI_API_KEY=sk-... (—Ç–≤–æ–π –∫–ª—é—á)
  EOF
  ```

4) –ó–∞–ø—É—Å—Ç–∏:
- ```bash
  docker compose up -d --build
```

---

**User**

–°—É–ø–µ—Ä, –Ω—É –ø–æ–≥–Ω–∞–ª–∏, —è —Ç–µ–±–µ –¥–æ—Å—Ç—É–ø—ã —Ç–∞–º:
–æ–º–µ–Ω
weasel-vps-2157268977935cdecd
–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
root
–ü–∞—Ä–æ–ª—å
7Lq0gpt20Y

---

**Cursor**

–Ø –Ω–µ –º–æ–≥—É –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ –≤–∞—à–∏ —Å–µ—Ä–≤–µ—Ä—ã –Ω–∞–ø—Ä—è–º—É—é –∏ –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø—ã. –î–∞–≤–∞–π—Ç–µ –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–¥–Ω–∏–º–µ–º –≤—Å—ë –Ω–∞ VPS –ø–æ ssh ‚Äî –∫–∞–∫ —É –≤–∞—Å –ª–æ–∫–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ docker compose.

–®–∞–≥–∏ (–∫–æ–ø–∏‚Äë–ø–∞—Å—Ç –∫–æ–º–∞–Ω–¥–∞–º–∏)

1) –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –ø–æ SSH –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É
- –ó–∞–º–µ–Ω–∏—Ç–µ SERVER_IP –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP —Å–µ—Ä–≤–µ—Ä–∞.
- –°—Ä–∞–∑—É —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∏ –ª—É—á—à–µ –≤–∫–ª—é—á–∏—Ç–µ ssh-–∫–ª—é—á–∏.
```
ssh root@SERVER_IP
passwd
apt update && apt -y upgrade
```

2) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ Compose
```
curl -fsSL https://get.docker.com | sh
apt-get install -y docker-compose-plugin git
```

3) –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
```
git clone https://github.com/EVRAG/Hostes_CRM.git
cd Hostes_CRM
```

4) –°–æ–∑–¥–∞–π—Ç–µ .env —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π IP/–¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ –≤ –¥–≤—É—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ.
- –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π OPENAI_API_KEY.
```
cat > .env << 'EOF'
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=crm_password
POSTGRES_DB=crm_db

DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
REDIS_URL=redis://redis:6379/0

JWT_SECRET=please_change_me
JWT_ALGORITHM=HS256

# –£–∫–∞–∂–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
VITE_API_URL=http://SERVER_IP:8000
FRONTEND_ORIGIN=http://SERVER_IP:5173

# –ö–ª—é—á OpenAI
OPENAI_API_KEY=sk-...your_key...
EOF
```

5) –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å—ë –≤ —Ñ–æ–Ω–µ
```
docker compose up -d --build
```

6) –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ë—ç–∫–µ–Ω–¥ Swagger: http://SERVER_IP:8000/docs
- –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://SERVER_IP:5173
- –õ–æ–≥–∏–Ω: admin / password123

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã/—Ñ–∞–µ—Ä–≤–æ–ª
- –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω UFW:
```
ufw allow 5173
ufw allow 8000
```

HTTPS –∏ –¥–æ–º–µ–Ω (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–º–µ–Ω ‚Äî –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å Caddy/NGINX –∫–∞–∫ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –Ω–∞ 80/443 –∏ –∑–∞–≤–µ—Ä–Ω—É—Ç—å –≤ TLS. –ú–æ–≥—É –¥–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π Caddyfile.

–í–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å root, —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å sudo –∏ –≤–∫–ª—é—á–∏—Ç–µ SSH-–∫–ª—é—á–∏.
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ OPENAI_API_KEY –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏; .env —É–∂–µ –≤ .gitignore.
- –ü—Ä–∏ —Å–º–µ–Ω–µ –¥–æ–º–µ–Ω–∞/–∞–¥—Ä–µ—Å–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–π—Ç–µ VITE_API_URL –∏ FRONTEND_ORIGIN –≤ .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π—Ç–µ:
```
docker compose down && docker compose up -d --build
```

–ù—É–∂–µ–Ω –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —Ä–µ–±—É—Ç–∞? Docker –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã; –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å restart policy –≤ compose, —Å–∫–∞–∂–∏—Ç–µ ‚Äî –¥–æ–±–∞–≤–ª—é.

```plaintext
ssh root@SERVER_IP
passwd
apt update && apt -y upgrade
```

```plaintext
curl -fsSL https://get.docker.com | sh
apt-get install -y docker-compose-plugin git
```

```plaintext
git clone https://github.com/EVRAG/Hostes_CRM.git
cd Hostes_CRM
```

```plaintext
cat > .env << 'EOF'
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=crm_password
POSTGRES_DB=crm_db

DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
REDIS_URL=redis://redis:6379/0

JWT_SECRET=please_change_me
JWT_ALGORITHM=HS256

# –£–∫–∞–∂–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
VITE_API_URL=http://SERVER_IP:8000
FRONTEND_ORIGIN=http://SERVER_IP:5173

# –ö–ª—é—á OpenAI
OPENAI_API_KEY=sk-...your_key...
EOF
```

```plaintext
docker compose up -d --build
```

```plaintext
ufw allow 5173
ufw allow 8000
```

```plaintext
docker compose down && docker compose up -d --build
```

---

**User**

root@weaselcloud-21572:~# curl -fsSL https://get.docker.com | sh
# Executing docker install script, commit: bedc5d6b3e782a5e50d3d2a870f5e1f1b5a38d5c

DEPRECATION WARNING
    This Linux distribution (ubuntu focal) reached end-of-life and is no longer supported by this script.
    No updates or security fixes will be released for this distribution, and users are recommended
    to upgrade to a currently maintained version of ubuntu.

Press Ctrl+C now to abort this script, or wait for the installation to continue.
+ sh -c apt-get -qq update >/dev/null
+ sh -c DEBIAN_FRONTEND=noninteractive apt-get -y -qq install ca-certificates curl >/dev/null
E: Could not get lock /var/lib/dpkg/lock-frontend. It is held by process 1729 (apt-get)
E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process using it?
root@weaselcloud-21572:~# apt-get install -y docker-compose-plugin git
E: Could not get lock /var/lib/dpkg/lock-frontend. It is held by process 1729 (apt-get)
N: Be aware that removing the lock file is not a solution and may break your system.
E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process using it?
root@weaselcloud-21572:~# 

---

**Cursor**

–£ —Ç–µ–±—è –∑–∞–Ω—è—Ç–æ apt/dpkg –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º (PID 1729), –ø–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–¥–∞—é—Ç. –°–¥–µ–ª–∞–π —Ç–∞–∫.

1) –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å –¥–µ—Ä–∂–∏—Ç lock, –∏ –ø–æ–¥–æ–∂–¥–∏ 1‚Äì3 –º–∏–Ω—É—Ç—ã
- –ß–∞—Å—Ç–æ —ç—Ç–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (apt-daily/cloud-init).
```
ps -fp 1729
```
–ï—Å–ª–∏ —ç—Ç–æ apt-get/apt-daily ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–æ–∂–¥–∏ –∏ –ø–æ–≤—Ç–æ—Ä–∏ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏. –ï—Å–ª–∏ –≤–∏—Å–∏—Ç –¥–æ–ª—å—à–µ 5‚Äì10 –º–∏–Ω—É—Ç, –ø–µ—Ä–µ–π–¥–∏ –∫ ‚Äú–µ—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª–æ‚Äù.

2) –ï—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª–æ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –î–µ–ª–∞–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ‚Äú–∑–∞–≤–∏—Å‚Äù.
```
kill -9 1729
dpkg --configure -a
apt-get -f install
apt-get update
```

3) –£—Å—Ç–∞–Ω–æ–≤–∏ Docker –∏ Compose (—á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
- focal EOL, –Ω–æ —Ä–µ–ø–æ Docker –¥–ª—è focal –µ—â—ë –¥–æ—Å—Ç—É–ø–Ω–æ. –í—ã–ø–æ–ª–Ω–∏:
```
apt-get install -y ca-certificates curl gnupg git
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg
. /etc/os-release
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu ${VERSION_CODENAME} stable" \
> /etc/apt/sources.list.d/docker.list
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
docker --version
docker compose version
```

4) –ó–∞–¥–µ–ø–ª–æ–π –Ω–∞—à –ø—Ä–æ–µ–∫—Ç –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–æ (docker compose)
```
git clone https://github.com/EVRAG/Hostes_CRM.git
cd Hostes_CRM
```
–°–æ–∑–¥–∞–π .env (–ø–æ–¥—Å—Ç–∞–≤—å –ø—É–±–ª–∏—á–Ω—ã–π IP/–¥–æ–º–µ–Ω VPS –∏ —Å–≤–æ–π OPENAI –∫–ª—é—á):
```
cat > .env << 'EOF'
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=crm_password
POSTGRES_DB=crm_db

DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
REDIS_URL=redis://redis:6379/0

JWT_SECRET=please_change_me
JWT_ALGORITHM=HS256

# –ü—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
VITE_API_URL=http://YOUR_SERVER_IP:8000
FRONTEND_ORIGIN=http://YOUR_SERVER_IP:5173

OPENAI_API_KEY=sk-...your_key...
EOF
```
–ó–∞–ø—É—Å—Ç–∏:
```
docker compose up -d --build
```

5) –ü—Ä–æ–≤–µ—Ä—å
- –ë—ç–∫–µ–Ω–¥: http://YOUR_SERVER_IP:8000/docs
- –§—Ä–æ–Ω—Ç: http://YOUR_SERVER_IP:5173
- –õ–æ–≥–∏–Ω: admin / password123

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –µ—â—ë –¥–µ—Ä–∂–∏—Ç lock ‚Äî –ø—Ä–∏—à–ª–∏ –≤—ã–≤–æ–¥:
- ps -fp 1729
- ps aux | grep -E 'apt|dpkg' | grep -v grep
- tail -n 100 /var/log/apt/term.log
–ü–æ–¥—Å–∫–∞–∂—É, —á—Ç–æ –∏–º–µ–Ω–Ω–æ ‚Äú–≤–∏—Å–∏—Ç‚Äù.

```plaintext
ps -fp 1729
```

```plaintext
kill -9 1729
dpkg --configure -a
apt-get -f install
apt-get update
```

```plaintext
apt-get install -y ca-certificates curl gnupg git
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg
. /etc/os-release
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/ubuntu ${VERSION_CODENAME} stable" \
> /etc/apt/sources.list.d/docker.list
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
docker --version
docker compose version
```

```plaintext
git clone https://github.com/EVRAG/Hostes_CRM.git
cd Hostes_CRM
```

```plaintext
cat > .env << 'EOF'
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=crm_password
POSTGRES_DB=crm_db

DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
REDIS_URL=redis://redis:6379/0

JWT_SECRET=please_change_me
JWT_ALGORITHM=HS256

# –ü—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
VITE_API_URL=http://YOUR_SERVER_IP:8000
FRONTEND_ORIGIN=http://YOUR_SERVER_IP:5173

OPENAI_API_KEY=sk-...your_key...
EOF
```

```plaintext
docker compose up -d --build
```

---

**User**

root@weaselcloud-21572:~# cat > .env << 'EOF'
> POSTGRES_USER=crm_user
> POSTGRES_PASSWORD=crm_password
> POSTGRES_DB=crm_db
> 
> DB_URL=postgresql+asyncpg://crm_user:crm_password@db:5432/crm_db
> REDIS_URL=redis://redis:6379/0
> 
> JWT_SECRET=please_change_me
> JWT_ALGORITHM=HS256
> 
> # –£–∫–∞–∂–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
> VITE_API_URL=http://93.115.203.88:8000
> FRONTEND_ORIGIN=http://93.115.203.88:5173
> 
> # –ö–ª—é—á OpenAI
> OPENAI_API_KEY=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
> EOF
root@weaselcloud-21572:~# docker compose up -d --build
no configuration file provided: not found
root@weaselcloud-21572:~# 

---

**Cursor**

–¢—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å –∫–æ–º–∞–Ω–¥—É –Ω–µ –∏–∑ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å docker-compose.yml. –§–∞–π–ª .env —Ç—ã —Å–æ–∑–¥–∞–ª –≤ /root, –∞ docker compose –∏—â–µ—Ç docker-compose.yml –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

–°–¥–µ–ª–∞–π —Ç–∞–∫:
- –ï—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—â—ë –Ω–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω:
  ```bash
  git clone https://github.com/EVRAG/Hostes_CRM.git
  cd Hostes_CRM
  ```
- –ü–µ—Ä–µ–Ω–µ—Å–∏ .env –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–∞–º –≥–¥–µ docker-compose.yml):
  ```bash
  mv ~/.env ./  # –µ—Å–ª–∏ .env –≤ /root
  ```
  –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ –µ—Å—Ç—å –æ–±–∞ —Ñ–∞–π–ª–∞:
  ```bash
  ls -la | grep -E 'docker-compose.yml|.env'
  ```
- –ó–∞–ø—É—Å—Ç–∏ —Å–±–æ—Ä–∫—É –∏ —Å—Ç–∞—Ä—Ç:
  ```bash
  docker compose up -d --build
  ```

–ü—Ä–æ–≤–µ—Ä–∫–∞:
- –ë—ç–∫–µ–Ω–¥: http://93.115.203.88:8000/docs
- –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://93.115.203.88:5173

–ï—Å–ª–∏ –ø–æ—Ä—Ç—ã –∑–∞–∫—Ä—ã—Ç—ã —Ñ–∞–µ—Ä–≤–æ–ª–æ–º:
```bash
ufw allow 8000
ufw allow 5173
```

–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–æ–º–∞–Ω–¥–∞ docker compose –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:
```bash
apt-get install -y docker-compose-plugin
docker compose version
```

```shellscript
  git clone https://github.com/EVRAG/Hostes_CRM.git
  cd Hostes_CRM
```

```shellscript
  mv ~/.env ./  # –µ—Å–ª–∏ .env –≤ /root
```

```shellscript
  ls -la | grep -E 'docker-compose.yml|.env'
```

```shellscript
  docker compose up -d --build
```

```shellscript
ufw allow 8000
ufw allow 5173
```

```shellscript
apt-get install -y docker-compose-plugin
docker compose version
```

